<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows-Android Connect 测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .device-list {
            margin-top: 20px;
        }
        .device-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Windows-Android Connect</h1>
        
        <div id="connectionStatus" class="status disconnected">
            未连接到服务器
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button id="connectBtn">连接服务器</button>
            <button id="disconnectBtn" disabled>断开连接</button>
        </div>
        
        <div id="deviceDiscovery">
            <h2>设备发现</h2>
            <div style="text-align: center; margin: 10px 0;">
                <button id="startDiscoveryBtn" disabled>开始设备发现</button>
                <button id="stopDiscoveryBtn" disabled>停止设备发现</button>
                <button id="refreshDevicesBtn" disabled>刷新设备列表</button>
            </div>
            <div id="deviceList" class="device-list">
                <p>暂无设备</p>
            </div>
        </div>
        
        <div id="fileTransfer">
            <h2>文件传输</h2>
            <div style="text-align: center; margin: 10px 0;">
                <button id="sendFileBtn" disabled>发送文件</button>
            </div>
        </div>
        
        <div id="screenStreaming">
            <h2>屏幕投屏</h2>
            <div style="text-align: center; margin: 10px 0;">
                <button id="startStreamingBtn" disabled>开始投屏</button>
                <button id="stopStreamingBtn" disabled>停止投屏</button>
            </div>
        </div>
        
        <div id="remoteControl">
            <h2>远程控制</h2>
            <div style="text-align: center; margin: 10px 0;">
                <button id="enableControlBtn" disabled>启用远程控制</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
        let socket = null;
        let discoveredDevices = [];
        
        // DOM元素
        const connectionStatus = document.getElementById('connectionStatus');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startDiscoveryBtn = document.getElementById('startDiscoveryBtn');
        const stopDiscoveryBtn = document.getElementById('stopDiscoveryBtn');
        const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
        const sendFileBtn = document.getElementById('sendFileBtn');
        const startStreamingBtn = document.getElementById('startStreamingBtn');
        const stopStreamingBtn = document.getElementById('stopStreamingBtn');
        const enableControlBtn = document.getElementById('enableControlBtn');
        const deviceList = document.getElementById('deviceList');
        
        // 更新连接状态显示
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.textContent = '已连接到服务器';
                connectionStatus.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                startDiscoveryBtn.disabled = false;
                stopDiscoveryBtn.disabled = false;
                refreshDevicesBtn.disabled = false;
                sendFileBtn.disabled = false;
                startStreamingBtn.disabled = false;
                stopStreamingBtn.disabled = false;
                enableControlBtn.disabled = false;
            } else {
                connectionStatus.textContent = '未连接到服务器';
                connectionStatus.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                startDiscoveryBtn.disabled = true;
                stopDiscoveryBtn.disabled = true;
                refreshDevicesBtn.disabled = true;
                sendFileBtn.disabled = true;
                startStreamingBtn.disabled = true;
                stopStreamingBtn.disabled = true;
                enableControlBtn.disabled = true;
            }
        }
        
        // 连接服务器
        connectBtn.addEventListener('click', () => {
            // 连接到WebSocket服务器
            socket = io('http://localhost:8828');
            
            socket.on('connect', () => {
                console.log('Connected to server');
                updateConnectionStatus(true);
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateConnectionStatus(false);
            });
            
            // 监听设备发现事件
            socket.on('device_discovered', (device) => {
                console.log('Device discovered:', device);
                // 添加到设备列表
                addDeviceToList(device);
            });
            
            // 监听设备状态更新
            socket.on('device_status_update', (update) => {
                console.log('Device status update:', update);
                // 更新设备状态
                updateDeviceStatus(update.id, update.status);
            });
        });
        
        // 断开连接
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateConnectionStatus(false);
                deviceList.innerHTML = '<p>暂无设备</p>';
                discoveredDevices = [];
            }
        });
        
        // 开始设备发现
        startDiscoveryBtn.addEventListener('click', () => {
            if (socket) {
                socket.emit('start_device_discovery', (response) => {
                    console.log('Device discovery response:', response);
                    if (response.success) {
                        // 清空设备列表
                        deviceList.innerHTML = '';
                        discoveredDevices = response.devices || [];
                        
                        // 显示设备列表
                        if (discoveredDevices.length > 0) {
                            discoveredDevices.forEach(device => {
                                addDeviceToList(device);
                            });
                        } else {
                            deviceList.innerHTML = '<p>暂无设备</p>';
                        }
                    } else {
                        alert('设备发现失败: ' + response.error);
                    }
                });
            }
        });
        
        // 停止设备发现
        stopDiscoveryBtn.addEventListener('click', () => {
            if (socket) {
                socket.emit('stop_device_discovery', (response) => {
                    console.log('Stop discovery response:', response);
                    if (response.success) {
                        alert('设备发现已停止');
                    } else {
                        alert('停止设备发现失败: ' + response.error);
                    }
                });
            }
        });
        
        // 刷新设备列表
        refreshDevicesBtn.addEventListener('click', () => {
            if (socket) {
                socket.emit('get_discovered_devices', (response) => {
                    console.log('Get devices response:', response);
                    if (response.success) {
                        // 清空设备列表
                        deviceList.innerHTML = '';
                        discoveredDevices = response.devices || [];
                        
                        // 显示设备列表
                        if (discoveredDevices.length > 0) {
                            discoveredDevices.forEach(device => {
                                addDeviceToList(device);
                            });
                        } else {
                            deviceList.innerHTML = '<p>暂无设备</p>';
                        }
                    } else {
                        alert('获取设备列表失败: ' + response.error);
                    }
                });
            }
        });
        
        // 发送文件
        sendFileBtn.addEventListener('click', () => {
            if (socket && discoveredDevices.length > 0) {
                // 模拟发送文件
                const device = discoveredDevices[0]; // 选择第一个设备
                socket.emit('send_file', {
                    deviceId: device.id,
                    fileName: 'test.txt',
                    fileSize: 1024
                }, (response) => {
                    console.log('Send file response:', response);
                    if (response.success) {
                        alert('文件发送成功');
                    } else {
                        alert('文件发送失败: ' + response.error);
                    }
                });
            } else {
                alert('请先发现设备');
            }
        });
        
        // 开始投屏
        startStreamingBtn.addEventListener('click', () => {
            if (socket && discoveredDevices.length > 0) {
                // 模拟开始投屏
                const device = discoveredDevices[0]; // 选择第一个设备
                socket.emit('start_screen_streaming', device, (response) => {
                    console.log('Start streaming response:', response);
                    if (response.success) {
                        alert('投屏已开始');
                    } else {
                        alert('开始投屏失败: ' + response.error);
                    }
                });
            } else {
                alert('请先发现设备');
            }
        });
        
        // 停止投屏
        stopStreamingBtn.addEventListener('click', () => {
            if (socket && discoveredDevices.length > 0) {
                // 模拟停止投屏
                const device = discoveredDevices[0]; // 选择第一个设备
                socket.emit('stop_screen_streaming', device, (response) => {
                    console.log('Stop streaming response:', response);
                    if (response.success) {
                        alert('投屏已停止');
                    } else {
                        alert('停止投屏失败: ' + response.error);
                    }
                });
            } else {
                alert('请先发现设备');
            }
        });
        
        // 启用远程控制
        enableControlBtn.addEventListener('click', () => {
            if (socket && discoveredDevices.length > 0) {
                // 模拟启用远程控制
                const device = discoveredDevices[0]; // 选择第一个设备
                socket.emit('enable_remote_control', device, (response) => {
                    console.log('Enable control response:', response);
                    if (response.success) {
                        alert('远程控制已启用');
                    } else {
                        alert('启用远程控制失败: ' + response.error);
                    }
                });
            } else {
                alert('请先发现设备');
            }
        });
        
        // 添加设备到列表
        function addDeviceToList(device) {
            const deviceElement = document.createElement('div');
            deviceElement.className = 'device-item';
            deviceElement.innerHTML = `
                <strong>${device.name || '未知设备'}</strong>
                <br>ID: ${device.id}
                <br>类型: ${device.type || '未知'}
                <br>状态: <span id="status-${device.id}">${device.status || '未知'}</span>
            `;
            deviceList.appendChild(deviceElement);
        }
        
        // 更新设备状态
        function updateDeviceStatus(deviceId, status) {
            const statusElement = document.getElementById(`status-${deviceId}`);
            if (statusElement) {
                statusElement.textContent = status;
            }
        }
        
        // 初始化
        updateConnectionStatus(false);
    </script>
</body>
</html>