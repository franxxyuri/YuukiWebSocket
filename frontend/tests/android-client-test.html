<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android客户端测试界面 - 模拟服务端</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            min-width: 120px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .control-panel {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .log-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        .log-info {
            color: #007bff;
        }
        .log-error {
            color: #dc3545;
        }
        .log-success {
            color: #28a745;
        }
        .log-warning {
            color: #ffc107;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        .message-list {
            margin-top: 10px;
        }
        .message-item {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
            background-color: #fff;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Android客户端测试界面 - 模拟服务端</h1>
        
        <div id="serverStatus" class="status disconnected">
            WebSocket服务器未启动
        </div>
        
        <div class="form-group">
            <label for="serverPort">服务器端口:</label>
            <input type="number" id="serverPort" value="8928" placeholder="输入服务器端口">
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button id="startServerBtn">启动模拟服务端</button>
            <button id="stopServerBtn" disabled>停止服务端</button>
        </div>
        
        <div id="connectionInfo">
            <h2>连接信息</h2>
            <p>当服务端启动后，Android客户端可以连接到: <strong>ws://localhost:8928/ws</strong></p>
            <div id="clientConnections">
                <h3>已连接的客户端:</h3>
                <div id="connectedClientsList">暂无连接</div>
            </div>
        </div>
        
        <div class="control-panel">
            <h2>模拟服务端功能</h2>
            
            <div class="form-group">
                <label for="messageType">消息类型:</label>
                <select id="messageType">
                    <option value="device_info">设备信息</option>
                    <option value="file_transfer">文件传输</option>
                    <option value="control_command">控制命令</option>
                    <option value="screen_frame">屏幕帧</option>
                    <option value="clipboard">剪贴板</option>
                    <option value="notification">通知</option>
                    <option value="heartbeat">心跳</option>
                    <option value="start_device_discovery">开始设备发现</option>
                    <option value="stop_device_discovery">停止设备发现</option>
                    <option value="get_discovered_devices">获取已发现设备</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="messageData">消息数据(JSON):</label>
                <textarea id="messageData" placeholder="输入要发送的消息数据">{}</textarea>
            </div>
            
            <div style="text-align: center; margin: 10px 0;">
                <button id="sendMessageBtn" disabled>发送消息给客户端</button>
                <button id="sendToAllBtn" disabled>发送消息给所有客户端</button>
            </div>
        </div>
        
        <div class="control-panel">
            <h2>预设消息测试</h2>
            <div style="text-align: center; margin: 10px 0;">
                <button id="sendDeviceInfoBtn" disabled>发送设备信息请求</button>
                <button id="requestFileTransferBtn" disabled>发送文件传输请求</button>
                <button id="requestScreenStreamingBtn" disabled>请求开始投屏</button>
                <button id="sendControlCommandBtn" disabled>发送控制命令</button>
            </div>
        </div>
        
        <div class="control-panel">
            <h2>收到的客户端消息</h2>
            <div id="receivedMessages" class="message-list">
                <p>暂无收到的消息</p>
            </div>
        </div>
        
        <div id="logPanel" class="log-panel">
            <h3>日志输出</h3>
            <div id="logEntries"></div>
        </div>
    </div>

    <script>
        let wsServer = null;
        let serverSocket = null;
        let connectedClients = new Map();
        let logEntries = [];
        let receivedMessages = [];
        
        // DOM元素
        const serverStatus = document.getElementById('serverStatus');
        const startServerBtn = document.getElementById('startServerBtn');
        const stopServerBtn = document.getElementById('stopServerBtn');
        const serverPortInput = document.getElementById('serverPort');
        const connectedClientsList = document.getElementById('connectedClientsList');
        const messageTypeSelect = document.getElementById('messageType');
        const messageDataTextarea = document.getElementById('messageData');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const sendToAllBtn = document.getElementById('sendToAllBtn');
        const sendDeviceInfoBtn = document.getElementById('sendDeviceInfoBtn');
        const requestFileTransferBtn = document.getElementById('requestFileTransferBtn');
        const requestScreenStreamingBtn = document.getElementById('requestScreenStreamingBtn');
        const sendControlCommandBtn = document.getElementById('sendControlCommandBtn');
        const receivedMessagesDiv = document.getElementById('receivedMessages');
        const logEntriesDiv = document.getElementById('logEntries');
        
        // 日志函数
        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                level
            };
            logEntries.push(logEntry);
            
            const logElement = document.createElement('div');
            logElement.className = `log-entry log-${level}`;
            logElement.textContent = `[${timestamp}] ${message}`;
            logEntriesDiv.appendChild(logElement);
            
            // 滚动到底部
            logEntriesDiv.scrollTop = logEntriesDiv.scrollHeight;
            
            // 限制日志数量
            if (logEntries.length > 100) {
                logEntries.shift();
                logEntriesDiv.removeChild(logEntriesDiv.firstChild);
            }
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        // 更新服务器状态显示
        function updateServerStatus(running) {
            if (running) {
                serverStatus.textContent = 'WebSocket服务器已启动';
                serverStatus.className = 'status connected';
                startServerBtn.disabled = true;
                stopServerBtn.disabled = false;
                sendMessageBtn.disabled = false;
                sendToAllBtn.disabled = false;
                sendDeviceInfoBtn.disabled = false;
                requestFileTransferBtn.disabled = false;
                requestScreenStreamingBtn.disabled = false;
                sendControlCommandBtn.disabled = false;
                log('WebSocket服务器已启动', 'success');
            } else {
                serverStatus.textContent = 'WebSocket服务器未启动';
                serverStatus.className = 'status disconnected';
                startServerBtn.disabled = false;
                stopServerBtn.disabled = true;
                sendMessageBtn.disabled = true;
                sendToAllBtn.disabled = true;
                sendDeviceInfoBtn.disabled = true;
                requestFileTransferBtn.disabled = true;
                requestScreenStreamingBtn.disabled = true;
                sendControlCommandBtn.disabled = true;
                log('WebSocket服务器已停止', 'warning');
            }
        }
        
        // 更新连接客户端列表
        function updateConnectedClientsList() {
            if (connectedClients.size === 0) {
                connectedClientsList.innerHTML = '暂无连接';
                return;
            }
            
            let html = '<ul>';
            connectedClients.forEach((client, clientId) => {
                html += `<li>${clientId} - ${client.type || 'unknown'} - ${client.ip || 'unknown'}</li>`;
            });
            html += '</ul>';
            
            connectedClientsList.innerHTML = html;
        }
        
        // 添加收到的消息到列表
        function addReceivedMessage(message, clientId) {
            const timestamp = new Date().toLocaleTimeString();
            const msg = {
                timestamp,
                clientId,
                message
            };
            receivedMessages.push(msg);
            
            // 清空列表并重新填充（最多显示20条）
            receivedMessagesDiv.innerHTML = '';
            
            // 倒序显示，最新的在最上面
            for (let i = Math.max(receivedMessages.length - 20, 0); i < receivedMessages.length; i++) {
                const msg = receivedMessages[i];
                const msgElement = document.createElement('div');
                msgElement.className = 'message-item';
                msgElement.textContent = `[${msg.timestamp}] Client: ${msg.clientId} - ${JSON.stringify(msg.message)}`;
                receivedMessagesDiv.appendChild(msgElement);
            }
            
            // 滚动到底部
            receivedMessagesDiv.scrollTop = receivedMessagesDiv.scrollHeight;
        }
        
        // 启动WebSocket服务器
        startServerBtn.addEventListener('click', () => {
            const port = parseInt(serverPortInput.value);
            if (isNaN(port) || port <= 0 || port > 65535) {
                log('无效的端口号', 'error');
                return;
            }
            
            try {
                // 在浏览器环境中，我们不能直接创建WebSocket服务器
                // 这里我们使用浏览器的WebSocket API，创建一个WebSocket服务端的功能模拟
                
                // 创建一个WebSocket服务端（这是浏览器环境下的模拟）
                log(`尝试启动WebSocket服务端在端口 ${port} (浏览器环境模拟)`, 'info');
                
                // 模拟WebSocket服务端功能
                serverSocket = {
                    clients: new Map(),
                    broadcast: function(message, excludeClientId = null) {
                        const messageStr = JSON.stringify(message);
                        for (const [clientId, clientSocket] of this.clients) {
                            if (clientId !== excludeClientId) {
                                try {
                                    // 这里模拟向客户端发送消息
                                    if (clientSocket.onmessage) {
                                        clientSocket.onmessage({ data: messageStr });
                                    }
                                } catch (error) {
                                    log(`向客户端 ${clientId} 发送消息失败: ${error.message}`, 'error');
                                }
                            }
                        }
                    },
                    sendTo: function(clientId, message) {
                        const clientSocket = this.clients.get(clientId);
                        if (clientSocket) {
                            try {
                                const messageStr = JSON.stringify(message);
                                if (clientSocket.onmessage) {
                                    clientSocket.onmessage({ data: messageStr });
                                }
                            } catch (error) {
                                log(`向客户端 ${clientId} 发送消息失败: ${error.message}`, 'error');
                            }
                        }
                    }
                };
                
                // 模拟服务端启动成功
                updateServerStatus(true);
                
                log(`模拟WebSocket服务器已在端口 ${port} 上启动`, 'success');
                log('Android客户端可以连接到: ws://localhost:8928/ws', 'info');
            } catch (error) {
                log(`启动WebSocket服务器失败: ${error.message}`, 'error');
                updateServerStatus(false);
            }
        });
        
        // 停止服务器
        stopServerBtn.addEventListener('click', () => {
            if (serverSocket) {
                // 关闭所有客户端连接
                for (const [clientId, clientSocket] of serverSocket.clients) {
                    try {
                        if (clientSocket.onclose) {
                            clientSocket.onclose();
                        }
                    } catch (error) {
                        log(`关闭客户端 ${clientId} 时出错: ${error.message}`, 'error');
                    }
                }
                
                serverSocket.clients.clear();
                serverSocket = null;
                
                connectedClients.clear();
                updateConnectedClientsList();
                
                updateServerStatus(false);
                log('WebSocket服务器已停止', 'info');
            }
        });
        
        // 发送消息给指定客户端
        sendMessageBtn.addEventListener('click', () => {
            if (!serverSocket) {
                log('服务器未启动', 'error');
                return;
            }
            
            const clientId = prompt('请输入客户端ID:');
            if (!clientId) return;
            
            try {
                const messageData = JSON.parse(messageDataTextarea.value);
                const message = {
                    type: messageTypeSelect.value,
                    ...messageData,
                    timestamp: Date.now()
                };
                
                serverSocket.sendTo(clientId, message);
                log(`已发送消息给客户端 ${clientId}: ${JSON.stringify(message)}`, 'success');
            } catch (error) {
                log(`发送消息失败: ${error.message}`, 'error');
            }
        });
        
        // 发送消息给所有客户端
        sendToAllBtn.addEventListener('click', () => {
            if (!serverSocket) {
                log('服务器未启动', 'error');
                return;
            }
            
            try {
                const messageData = JSON.parse(messageDataTextarea.value);
                const message = {
                    type: messageTypeSelect.value,
                    ...messageData,
                    timestamp: Date.now()
                };
                
                serverSocket.broadcast(message);
                log(`已发送消息给所有客户端: ${JSON.stringify(message)}`, 'success');
            } catch (error) {
                log(`发送消息失败: ${error.message}`, 'error');
            }
        });
        
        // 发送设备信息请求
        sendDeviceInfoBtn.addEventListener('click', () => {
            if (!serverSocket) {
                log('服务器未启动', 'error');
                return;
            }
            
            const message = {
                type: 'device_info',
                deviceInfo: {
                    platform: 'web',
                    deviceName: 'Test Server',
                    deviceId: 'server-' + Date.now()
                },
                timestamp: Date.now()
            };
            
            serverSocket.broadcast(message);
            log('已发送设备信息请求', 'success');
        });
        
        // 发送文件传输请求
        requestFileTransferBtn.addEventListener('click', () => {
            if (!serverSocket) {
                log('服务器未启动', 'error');
                return;
            }
            
            const message = {
                type: 'file_transfer',
                action: 'request',
                fileName: 'test.txt',
                fileSize: 1024,
                source: 'server',
                timestamp: Date.now()
            };
            
            serverSocket.broadcast(message);
            log('已发送文件传输请求', 'success');
        });
        
        // 请求开始投屏
        requestScreenStreamingBtn.addEventListener('click', () => {
            if (!serverSocket) {
                log('服务器未启动', 'error');
                return;
            }
            
            const message = {
                type: 'control_command',
                commandType: 'start_streaming',
                target: 'android',
                timestamp: Date.now()
            };
            
            serverSocket.broadcast(message);
            log('已发送开始投屏请求', 'success');
        });
        
        // 发送控制命令
        sendControlCommandBtn.addEventListener('click', () => {
            if (!serverSocket) {
                log('服务器未启动', 'error');
                return;
            }
            
            const message = {
                type: 'control_command',
                commandType: 'click',
                x: 100,
                y: 200,
                timestamp: Date.now()
            };
            
            serverSocket.broadcast(message);
            log('已发送控制命令', 'success');
        });
        
        // 初始化
        updateServerStatus(false);
        
        // 模拟WebSocket客户端连接
        window.mockWebSocketClient = function(url) {
            log(`模拟WebSocket客户端连接到: ${url}`, 'info');
            
            // 生成客户端ID
            const clientId = 'client-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            // 创建模拟客户端对象
            const client = {
                url: url,
                clientId: clientId,
                onopen: null,
                onclose: null,
                onerror: null,
                onmessage: null,
                readyState: 0, // CONNECTING
                send: function(data) {
                    log(`客户端 ${clientId} 发送数据: ${data}`, 'info');
                    
                    // 模拟向服务器发送数据
                    try {
                        const message = JSON.parse(data);
                        addReceivedMessage(message, clientId);
                        
                        // 根据消息类型进行处理
                        switch(message.type) {
                            case 'device_info':
                                log(`收到设备信息: ${JSON.stringify(message.deviceInfo)}`, 'success');
                                break;
                            case 'screen_frame':
                                log(`收到屏幕帧: ${message.timestamp}`, 'info');
                                break;
                            case 'file_transfer':
                                log(`收到文件传输消息: ${message.action}`, 'info');
                                break;
                            case 'control_command':
                                log(`收到控制命令: ${message.commandType}`, 'info');
                                break;
                            default:
                                log(`收到未知消息类型: ${message.type}`, 'warning');
                                break;
                        }
                    } catch (error) {
                        log(`解析客户端消息失败: ${error.message}`, 'error');
                    }
                },
                close: function() {
                    log(`客户端 ${clientId} 已关闭`, 'warning');
                    if (serverSocket) {
                        serverSocket.clients.delete(clientId);
                        connectedClients.delete(clientId);
                        updateConnectedClientsList();
                    }
                }
            };
            
            // 将客户端添加到服务器
            if (serverSocket) {
                serverSocket.clients.set(clientId, client);
                connectedClients.set(clientId, {
                    id: clientId,
                    type: 'android', // 模拟Android客户端
                    ip: '127.0.0.1',
                    connectedAt: Date.now()
                });
                updateConnectedClientsList();
                
                // 模拟连接成功
                client.readyState = 1; // OPEN
                if (client.onopen) {
                    client.onopen();
                }
                
                log(`客户端 ${clientId} 已连接`, 'success');
            }
            
            return client;
        };
        
        // 提供一个全局函数，用于在控制台中测试
        window.connectAndroidClient = function() {
            if (!serverSocket) {
                log('请先启动服务器', 'error');
                return;
            }
            
            const client = window.mockWebSocketClient('ws://localhost:8928/ws');
            log('已创建模拟Android客户端', 'success');
            return client;
        };
    </script>
</body>
</html>