<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡ç«¯åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log-area {
            width: 100%;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 14px;
        }
        .device-info {
            margin: 10px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æœåŠ¡ç«¯åŠŸèƒ½æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•Windows-Android ConnectæœåŠ¡ç«¯çš„å„é¡¹åŠŸèƒ½</p>
        
        <div class="status info" id="local-ip-display">æ­£åœ¨è·å–æœ¬æœºIPåœ°å€...</div>
        <div class="status info" id="server-status">æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...</div>
        
        <h2>è®¾å¤‡å‘ç°ä¸è¿æ¥</h2>
        <div class="status info" id="device-search-status">å‡†å¤‡å°±ç»ª</div>
        <div style="display: flex; gap: 10px; align-items: center; margin: 10px 0;">
            <input type="text" id="ip-input" placeholder="è¾“å…¥è®¾å¤‡IPåœ°å€ (ä¾‹å¦‚: 192.168.1.100)" style="width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <button class="btn-primary" id="search-ip-btn">æœç´¢IP</button>
            <button class="btn-success" id="scan-network-btn">æ‰«æå±€åŸŸç½‘</button>
        </div>
        <div id="search-results" style="margin-top: 10px;"></div>
        
        <h2>WebSocketè¿æ¥æµ‹è¯•</h2>
        <div class="status info" id="websocket-status">æœªè¿æ¥</div>
        <button class="btn-primary" id="connect-btn">è¿æ¥åˆ°æœåŠ¡å™¨</button>
        <button class="btn-danger" id="disconnect-btn">æ–­å¼€è¿æ¥</button>
        <button class="btn-warning" id="send-test-btn">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
        <button class="btn-success" id="start-discovery-btn">å¼€å§‹è®¾å¤‡å‘ç°</button>
        <button class="btn-warning" id="stop-discovery-btn">åœæ­¢è®¾å¤‡å‘ç°</button>
        <button class="btn-primary" id="get-devices-btn">è·å–è®¾å¤‡åˆ—è¡¨</button>
        <button class="btn-success" id="send-device-info-btn">å‘é€è®¾å¤‡ä¿¡æ¯</button>
        <br><br>
        <label>æ¶ˆæ¯ç±»å‹: </label>
        <select id="message-type">
            <option value="control_command">æ§åˆ¶å‘½ä»¤</option>
            <option value="file_transfer">æ–‡ä»¶ä¼ è¾“</option>
            <option value="clipboard">å‰ªè´´æ¿åŒæ­¥</option>
            <option value="notification">é€šçŸ¥</option>
            <option value="heartbeat">å¿ƒè·³</option>
        </select>
        <input type="text" id="message-content" placeholder="æ¶ˆæ¯å†…å®¹" style="width: 300px;">
        <button class="btn-primary" id="send-custom-btn">å‘é€è‡ªå®šä¹‰æ¶ˆæ¯</button>
        <br><br>
        <label>ç›®æ ‡è®¾å¤‡ID: </label>
        <input type="text" id="target-device" placeholder="è®¾å¤‡ID" style="width: 200px;">
        <label>å‘½ä»¤ç±»å‹: </label>
        <select id="command-type">
            <option value="tap">ç‚¹å‡»(tap)</option>
            <option value="swipe">æ»‘åŠ¨(swipe)</option>
            <option value="key">æŒ‰é”®(key)</option>
            <option value="text">è¾“å…¥æ–‡æœ¬(text)</option>
        </select>
        <button class="btn-primary" id="send-control-btn">å‘é€æ§åˆ¶å‘½ä»¤</button>
        <br><br>
        <div id="discovered-devices"></div>
        <br>
        <h2>æ—¥å¿—è¾“å‡º</h2>
        <div class="log-area" id="log-area"></div>
    </div>

    <script>
        // WebSocketè¿æ¥
        let ws = null;
        let isConnected = false;
        let discoveryInterval = null;
        let discoveredDevices = {};
        
        // DOMå…ƒç´ 
        const elements = {
            localIPDisplay: document.getElementById('local-ip-display'),
            serverStatus: document.getElementById('server-status'),
            websocketStatus: document.getElementById('websocket-status'),
            deviceSearchStatus: document.getElementById('device-search-status'),
            ipInput: document.getElementById('ip-input'),
            searchIpBtn: document.getElementById('search-ip-btn'),
            scanNetworkBtn: document.getElementById('scan-network-btn'),
            searchResults: document.getElementById('search-results'),
            connectBtn: document.getElementById('connect-btn'),
            disconnectBtn: document.getElementById('disconnect-btn'),
            sendTestBtn: document.getElementById('send-test-btn'),
            startDiscoveryBtn: document.getElementById('start-discovery-btn'),
            stopDiscoveryBtn: document.getElementById('stop-discovery-btn'),
            getDevicesBtn: document.getElementById('get-devices-btn'),
            sendDeviceInfoBtn: document.getElementById('send-device-info-btn'),
            sendCustomBtn: document.getElementById('send-custom-btn'),
            sendControlBtn: document.getElementById('send-control-btn'),
            logArea: document.getElementById('log-area'),
            messageContent: document.getElementById('message-content'),
            messageType: document.getElementById('message-type'),
            targetDevice: document.getElementById('target-device'),
            commandType: document.getElementById('command-type'),
            discoveredDevices: document.getElementById('discovered-devices')
        };
        
        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}">${message}</span>`;
            elements.logArea.appendChild(logEntry);
            elements.logArea.scrollTop = elements.logArea.scrollHeight;
        }
        
        // è·å–æœ¬åœ°IPåœ°å€
        async function getLocalIP() {
            try {
                // ä½¿ç”¨WebRTC APIè·å–æœ¬åœ°IPåœ°å€
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                const ips = [];
                pc.createDataChannel('');
                pc.createOffer()
                    .then(offer => pc.setLocalDescription(offer))
                    .catch(() => {});
                
                pc.onicecandidate = (ice) => {
                    if (ice && ice.candidate && ice.candidate.candidate) {
                        const myIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate)[1];
                        
                        if (myIP && !myIP.startsWith('192.168.1') && !myIP.startsWith('10.') && !myIP.startsWith('172.')) {
                            // è¿™æ˜¯ä¸€ä¸ªå…¬ç½‘IPï¼Œè·³è¿‡
                        } else {
                            // è¿™æ˜¯ä¸€ä¸ªå±€åŸŸç½‘IP
                            ips.push(myIP);
                        }
                    }
                };
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´æ”¶é›†IPåœ°å€
                setTimeout(() => {
                    pc.close();
                    if (ips.length > 0) {
                        const localIP = ips[0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„IP
                        elements.localIPDisplay.className = 'status success';
                        elements.localIPDisplay.innerHTML = `ğŸ’» æœ¬æœºIPåœ°å€: ${localIP} (ç«¯å£ 8928)`;
                    } else {
                        // å¦‚æœWebRTCæ–¹æ³•å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤IP
                        elements.localIPDisplay.className = 'status info';
                        elements.localIPDisplay.innerHTML = `ğŸ’» æœ¬æœºIPåœ°å€: 192.168.124.18 (ç«¯å£ 8928) - è¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´`;
                    }
                }, 1000);
            } catch (error) {
                // å¦‚æœWebRTCæ–¹æ³•å¤±è´¥ï¼Œæ˜¾ç¤ºç”¨æˆ·æŒ‡å®šçš„IP
                elements.localIPDisplay.className = 'status info';
                elements.localIPDisplay.innerHTML = `ğŸ’» æœ¬æœºIPåœ°å€: 192.168.124.18 (ç«¯å£ 8928) - è¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´`;
            }
        }
        
        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:8928/api/status');
                if (response.ok) {
                    const data = await response.json();
                    elements.serverStatus.className = 'status success';
                    elements.serverStatus.innerHTML = `âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸ - Androidè¿æ¥: ${data.androidConnected ? 'æ˜¯' : 'å¦'}, å®¢æˆ·ç«¯æ•°: ${data.totalClients}, æ—¶é—´æˆ³: ${new Date(data.timestamp).toLocaleString()}`;
                } else {
                    elements.serverStatus.className = 'status error';
                    elements.serverStatus.innerHTML = `âŒ æœåŠ¡å™¨æœªå“åº” - çŠ¶æ€ç : ${response.status}`;
                }
            } catch (error) {
                elements.serverStatus.className = 'status error';
                elements.serverStatus.innerHTML = `âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥ - ${error.message}`;
            }
        }
        
        // è¿æ¥åˆ°WebSocketæœåŠ¡å™¨
        function connectToServer() {
            // æ ¹æ®å½“å‰é¡µé¢URLå†³å®šWebSocketè¿æ¥åœ°å€
            const isViteDevServer = window.location.port === '8781';
            const wsUrl = isViteDevServer ? 'ws://localhost:8781/ws' : 'ws://localhost:8928';
            
            log(`å°è¯•è¿æ¥åˆ°: ${wsUrl}`);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                log('WebSocketè¿æ¥å·²å»ºç«‹', 'success');
                isConnected = true;
                elements.websocketStatus.className = 'status success';
                elements.websocketStatus.textContent = 'å·²è¿æ¥åˆ°æœåŠ¡å™¨';
                elements.connectBtn.disabled = true;
                elements.disconnectBtn.disabled = false;
            };
            
            ws.onclose = function(event) {
                log('WebSocketè¿æ¥å·²å…³é—­', 'info');
                isConnected = false;
                elements.websocketStatus.className = 'status info';
                elements.websocketStatus.textContent = 'å·²æ–­å¼€è¿æ¥';
                elements.connectBtn.disabled = false;
                elements.disconnectBtn.disabled = true;
            };
            
            ws.onerror = function(error) {
                log(`WebSocketè¿æ¥é”™è¯¯: ${error.message}`, 'error');
                elements.websocketStatus.className = 'status error';
                elements.websocketStatus.textContent = 'è¿æ¥é”™è¯¯';
            };
            
            ws.onmessage = function(event) {
                log(`æ”¶åˆ°æ¶ˆæ¯: ${event.data.substring(0, 100)}${event.data.length > 100 ? '...' : ''}`, 'success');
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (e) {
                    log(`æ¶ˆæ¯è§£æå¤±è´¥: ${e.message}`, 'error');
                }
            };
        }
        
        // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        function handleMessage(message) {
            switch (message.type) {
                case 'connection_established':
                    log(`è¿æ¥å·²å»ºç«‹ - å®¢æˆ·ç«¯ID: ${message.clientId}`, 'success');
                    break;
                case 'device_found':
                    handleDeviceFound(message.device);
                    break;
                case 'android_connected':
                    log(`Androidè®¾å¤‡å·²è¿æ¥: ${message.deviceInfo.deviceName}`, 'success');
                    break;
                case 'android_disconnected':
                    log('Androidè®¾å¤‡å·²æ–­å¼€è¿æ¥', 'info');
                    break;
                case 'screen_frame':
                    log('æ”¶åˆ°å±å¹•å¸§æ•°æ®', 'info');
                    break;
                case 'file_transfer':
                    log(`æ–‡ä»¶ä¼ è¾“: ${message.action}`, 'info');
                    break;
                case 'clipboard':
                    log(`å‰ªè´´æ¿åŒæ­¥: ${message.data.substring(0, 50)}...`, 'info');
                    break;
                case 'notification':
                    log(`é€šçŸ¥: ${message.title}`, 'info');
                    break;
                case 'heartbeat':
                    log('æ”¶åˆ°å¿ƒè·³å“åº”', 'info');
                    break;
                case 'error':
                    log(`æœåŠ¡å™¨é”™è¯¯: ${message.message}`, 'error');
                    break;
                case 'start_device_discovery_response':
                    log(`å¼€å§‹è®¾å¤‡å‘ç°: ${message.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, message.success ? 'success' : 'error');
                    break;
                case 'stop_device_discovery_response':
                    log(`åœæ­¢è®¾å¤‡å‘ç°: ${message.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, message.success ? 'success' : 'error');
                    break;
                case 'get_discovered_devices_response':
                    log(`è·å–è®¾å¤‡åˆ—è¡¨: ${message.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, message.success ? 'success' : 'error');
                    if (message.success) {
                        log(`å‘ç°è®¾å¤‡æ•°é‡: ${message.devices.length}`, 'info');
                        updateDiscoveredDevicesList(message.devices);
                    }
                    break;
                default:
                    log(`æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${message.type}`, 'info');
                    break;
            }
        }
        
        // å¤„ç†å‘ç°çš„è®¾å¤‡
        function handleDeviceFound(device) {
            discoveredDevices[device.deviceId] = device;
            log(`å‘ç°è®¾å¤‡: ${device.deviceName} (${device.ip})`, 'success');
            updateDiscoveredDevicesList(Object.values(discoveredDevices));
        }
        
        // æ›´æ–°å‘ç°çš„è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
        function updateDiscoveredDevicesList(devices) {
            elements.discoveredDevices.innerHTML = '<h3>å·²å‘ç°çš„è®¾å¤‡:</h3>';
            if (devices.length === 0) {
                elements.discoveredDevices.innerHTML += '<p>æ²¡æœ‰å‘ç°è®¾å¤‡</p>';
                return;
            }
            
            devices.forEach(device => {
                const deviceDiv = document.createElement('div');
                deviceDiv.className = 'device-info';
                deviceDiv.innerHTML = `
                    <strong>${device.deviceName}</strong><br>
                    ID: ${device.deviceId}<br>
                    IP: ${device.ip}<br>
                    å¹³å°: ${device.platform || 'unknown'}<br>
                    æœ€åå‘ç°: ${new Date(device.lastSeen || Date.now()).toLocaleString()}
                `;
                elements.discoveredDevices.appendChild(deviceDiv);
            });
        }
        
        // å‘é€æµ‹è¯•æ¶ˆæ¯
        function sendTestMessage() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }
            
            const message = {
                type: 'test_message',
                content: 'Hello from test client',
                timestamp: Date.now()
            };
            
            ws.send(JSON.stringify(message));
            log('æµ‹è¯•æ¶ˆæ¯å·²å‘é€', 'success');
        }
        
        // å‘é€è®¾å¤‡ä¿¡æ¯
        function sendDeviceInfo() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }
            
            const deviceInfo = {
                platform: 'web_test_client',
                deviceName: 'Test Client ' + new Date().toLocaleTimeString(),
                deviceId: 'web-test-' + Date.now(),
                capabilities: ['test', 'web']
            };
            
            const message = {
                type: 'device_info',
                deviceInfo: deviceInfo
            };
            
            ws.send(JSON.stringify(message));
            log('è®¾å¤‡ä¿¡æ¯å·²å‘é€', 'success');
        }
        
        // å¼€å§‹è®¾å¤‡å‘ç°
        function startDeviceDiscovery() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }
            
            const message = {
                type: 'start_device_discovery'
            };
            
            ws.send(JSON.stringify(message));
            log('è®¾å¤‡å‘ç°è¯·æ±‚å·²å‘é€', 'success');
        }
        
        // åœæ­¢è®¾å¤‡å‘ç°
        function stopDeviceDiscovery() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }
            
            const message = {
                type: 'stop_device_discovery'
            };
            
            ws.send(JSON.stringify(message));
            log('åœæ­¢è®¾å¤‡å‘ç°è¯·æ±‚å·²å‘é€', 'success');
        }
        
        // è·å–è®¾å¤‡åˆ—è¡¨
        function getDevices() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }
            
            const message = {
                type: 'get_discovered_devices'
            };
            
            ws.send(JSON.stringify(message));
            log('è·å–è®¾å¤‡åˆ—è¡¨è¯·æ±‚å·²å‘é€', 'success');
        }
        
        // å‘é€è‡ªå®šä¹‰æ¶ˆæ¯
        function sendCustomMessage() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }
            
            const messageType = elements.messageType.value;
            const content = elements.messageContent.value;
            
            if (!content) {
                log('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }
            
            let message = {};
            switch (messageType) {
                case 'control_command':
                    message = {
                        type: 'control_command',
                        commandType: 'tap',
                        x: 100,
                        y: 100,
                        deviceId: elements.targetDevice.value || null
                    };
                    break;
                case 'file_transfer':
                    message = {
                        type: 'file_transfer',
                        action: 'send',
                        fileName: 'test.txt',
                        fileSize: 1024,
                        content: content
                    };
                    break;
                case 'clipboard':
                    message = {
                        type: 'clipboard',
                        action: 'sync',
                        data: content
                    };
                    break;
                case 'notification':
                    message = {
                        type: 'notification',
                        action: 'show',
                        title: 'æµ‹è¯•é€šçŸ¥',
                        content: content
                    };
                    break;
                case 'heartbeat':
                    message = {
                        type: 'heartbeat',
                        timestamp: Date.now()
                    };
                    break;
                default:
                    message = {
                        type: messageType,
                        content: content
                    };
            }
            
            ws.send(JSON.stringify(message));
            log(`è‡ªå®šä¹‰æ¶ˆæ¯å·²å‘é€: ${JSON.stringify(message)}`, 'success');
        }
        
        // å‘é€æ§åˆ¶å‘½ä»¤
        function sendControlCommand() {
            if (!isConnected) {
                log('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }
            
            const commandType = elements.commandType.value;
            const targetDevice = elements.targetDevice.value;
            
            let command = {};
            switch (commandType) {
                case 'tap':
                    command = {
                        type: 'control_command',
                        commandType: 'tap',
                        x: 100,
                        y: 100,
                        deviceId: targetDevice || null
                    };
                    break;
                case 'swipe':
                    command = {
                        type: 'control_command',
                        commandType: 'swipe',
                        startX: 100,
                        startY: 100,
                        endX: 200,
                        endY: 200,
                        deviceId: targetDevice || null
                    };
                    break;
                case 'key':
                    command = {
                        type: 'control_command',
                        commandType: 'key',
                        keyCode: 65, // Aé”®
                        key: 'a',
                        deviceId: targetDevice || null
                    };
                    break;
                case 'text':
                    command = {
                        type: 'control_command',
                        commandType: 'text',
                        text: 'Hello from web client',
                        deviceId: targetDevice || null
                    };
                    break;
            }
            
            ws.send(JSON.stringify(command));
            log(`æ§åˆ¶å‘½ä»¤å·²å‘é€: ${JSON.stringify(command)}`, 'success');
        }
        
        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (ws) {
                ws.close();
                log('æ­£åœ¨æ–­å¼€è¿æ¥...', 'info');
            }
        }
        
        // æœç´¢ç‰¹å®šIPçš„è®¾å¤‡
        async function searchDeviceByIP() {
            const ip = elements.ipInput.value.trim();
            if (!ip) {
                elements.deviceSearchStatus.className = 'status error';
                elements.deviceSearchStatus.textContent = 'è¯·è¾“å…¥IPåœ°å€';
                return;
            }
            
            // éªŒè¯IPåœ°å€æ ¼å¼
            const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipPattern.test(ip)) {
                elements.deviceSearchStatus.className = 'status error';
                elements.deviceSearchStatus.textContent = 'IPåœ°å€æ ¼å¼ä¸æ­£ç¡®';
                return;
            }
            
            elements.deviceSearchStatus.className = 'status info';
            elements.deviceSearchStatus.textContent = `æ­£åœ¨æœç´¢è®¾å¤‡: ${ip}...`;
            
            try {
                // å°è¯•è¿æ¥åˆ°æŒ‡å®šIPçš„WebSocketæœåŠ¡
                const wsUrl = `ws://${ip}:8928`;
                const testWs = new WebSocket(wsUrl);
                
                // è®¾ç½®è¶…æ—¶
                const timeout = setTimeout(() => {
                    testWs.close();
                    elements.deviceSearchStatus.className = 'status error';
                    elements.deviceSearchStatus.textContent = `è®¾å¤‡ ${ip} æœªå“åº”`;
                }, 3000);
                
                testWs.onopen = function() {
                    clearTimeout(timeout);
                    testWs.close();
                    elements.deviceSearchStatus.className = 'status success';
                    elements.deviceSearchStatus.textContent = `åœ¨ ${ip} å‘ç°è®¾å¤‡!`;
                    
                    // æ˜¾ç¤ºæœç´¢ç»“æœ
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'device-info';
                    resultDiv.innerHTML = `
                        <strong>å‘ç°è®¾å¤‡</strong><br>
                        IP: ${ip}<br>
                        çŠ¶æ€: <span style="color: #28a745">åœ¨çº¿</span><br>
                        ç«¯å£: 8928<br>
                        <button class="btn-primary" onclick="connectToIP('${ip}')">è¿æ¥åˆ°æ­¤è®¾å¤‡</button>
                    `;
                    elements.searchResults.appendChild(resultDiv);
                };
                
                testWs.onerror = function() {
                    clearTimeout(timeout);
                    testWs.close();
                    elements.deviceSearchStatus.className = 'status error';
                    elements.deviceSearchStatus.textContent = `æ— æ³•è¿æ¥åˆ° ${ip}`;
                };
                
            } catch (error) {
                elements.deviceSearchStatus.className = 'status error';
                elements.deviceSearchStatus.textContent = `æœç´¢å¤±è´¥: ${error.message}`;
            }
        }
        
        // æ‰«æå±€åŸŸç½‘ä¸­çš„è®¾å¤‡
        async function scanNetworkForDevices() {
            // è·å–æœ¬æœºIPå¹¶ç¡®å®šå­ç½‘
            const localIP = elements.localIPDisplay.textContent.match(/(\d+\.\d+\.\d+)\.(\d+)/);
            if (!localIP) {
                elements.deviceSearchStatus.className = 'status error';
                elements.deviceSearchStatus.textContent = 'æ— æ³•ç¡®å®šå±€åŸŸç½‘å­ç½‘';
                return;
            }
            
            const subnet = localIP[1];
            elements.deviceSearchStatus.className = 'status info';
            elements.deviceSearchStatus.textContent = `æ­£åœ¨æ‰«æå­ç½‘: ${subnet}.0/24...`;
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™éœ€è¦åç«¯æ”¯æŒæ¥æ‰«ææ•´ä¸ªå­ç½‘
            // è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿæ‰«æè¿‡ç¨‹
            log(`å¼€å§‹æ‰«æå±€åŸŸç½‘è®¾å¤‡ (å­ç½‘: ${subnet}.0/24)`, 'info');
            
            // æ¨¡æ‹Ÿæ‰«æè¿‡ç¨‹ - å®é™…åº”ç”¨ä¸­éœ€è¦åç«¯APIæ”¯æŒ
            elements.deviceSearchStatus.className = 'status info';
            elements.deviceSearchStatus.textContent = `å±€åŸŸç½‘æ‰«æå®Œæˆã€‚è¯·ä½¿ç”¨"æœç´¢IP"åŠŸèƒ½æ£€æŸ¥ç‰¹å®šè®¾å¤‡ã€‚`;
        }
        
        // è¿æ¥åˆ°ç‰¹å®šIPçš„è®¾å¤‡
        function connectToIP(ip) {
            log(`å‡†å¤‡è¿æ¥åˆ°è®¾å¤‡: ${ip}`, 'info');
            // æ›´æ–°WebSocketè¿æ¥åœ°å€
            const wsUrl = `ws://${ip}:8928`;
            log(`WebSocket URL: ${wsUrl}`, 'info');
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            elements.connectBtn.addEventListener('click', connectToServer);
            elements.disconnectBtn.addEventListener('click', disconnect);
            elements.sendTestBtn.addEventListener('click', sendTestMessage);
            elements.startDiscoveryBtn.addEventListener('click', startDeviceDiscovery);
            elements.stopDiscoveryBtn.addEventListener('click', stopDeviceDiscovery);
            elements.getDevicesBtn.addEventListener('click', getDevices);
            elements.sendDeviceInfoBtn.addEventListener('click', sendDeviceInfo);
            elements.sendCustomBtn.addEventListener('click', sendCustomMessage);
            elements.sendControlBtn.addEventListener('click', sendControlCommand);
            
            // è®¾å¤‡æœç´¢åŠŸèƒ½çš„äº‹ä»¶ç›‘å¬å™¨
            elements.searchIpBtn.addEventListener('click', searchDeviceByIP);
            elements.scanNetworkBtn.addEventListener('click', scanNetworkForDevices);
            
            // æŒ‰Enteré”®æœç´¢IP
            elements.ipInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchDeviceByIP();
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 'info');
            getLocalIP(); // è·å–æœ¬åœ°IPåœ°å€
            checkServerStatus();
            setupEventListeners();
            elements.disconnectBtn.disabled = true;
        });
    </script>
</body>
</html>