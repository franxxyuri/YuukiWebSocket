<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务端功能测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log-area {
            width: 100%;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 14px;
        }
        .device-info {
            margin: 10px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>服务端功能测试</h1>
        <p>此页面用于测试Windows-Android Connect服务端的各项功能</p>
        
        <div class="status info" id="server-status">正在检查服务器状态...</div>
        
        <h2>WebSocket连接测试</h2>
        <div class="status info" id="websocket-status">未连接</div>
        <button class="btn-primary" id="connect-btn">连接到服务器</button>
        <button class="btn-danger" id="disconnect-btn">断开连接</button>
        <button class="btn-warning" id="send-test-btn">发送测试消息</button>
        <button class="btn-success" id="start-discovery-btn">开始设备发现</button>
        <button class="btn-warning" id="stop-discovery-btn">停止设备发现</button>
        <button class="btn-primary" id="get-devices-btn">获取设备列表</button>
        <button class="btn-success" id="send-device-info-btn">发送设备信息</button>
        <br><br>
        <label>消息类型: </label>
        <select id="message-type">
            <option value="control_command">控制命令</option>
            <option value="file_transfer">文件传输</option>
            <option value="clipboard">剪贴板同步</option>
            <option value="notification">通知</option>
            <option value="heartbeat">心跳</option>
        </select>
        <input type="text" id="message-content" placeholder="消息内容" style="width: 300px;">
        <button class="btn-primary" id="send-custom-btn">发送自定义消息</button>
        <br><br>
        <label>目标设备ID: </label>
        <input type="text" id="target-device" placeholder="设备ID" style="width: 200px;">
        <label>命令类型: </label>
        <select id="command-type">
            <option value="tap">点击(tap)</option>
            <option value="swipe">滑动(swipe)</option>
            <option value="key">按键(key)</option>
            <option value="text">输入文本(text)</option>
        </select>
        <button class="btn-primary" id="send-control-btn">发送控制命令</button>
        <br><br>
        <div id="discovered-devices"></div>
        <br>
        <h2>日志输出</h2>
        <div class="log-area" id="log-area"></div>
    </div>

    <script>
        // WebSocket连接
        let ws = null;
        let isConnected = false;
        let discoveryInterval = null;
        let discoveredDevices = {};
        
        // DOM元素
        const elements = {
            serverStatus: document.getElementById('server-status'),
            websocketStatus: document.getElementById('websocket-status'),
            connectBtn: document.getElementById('connect-btn'),
            disconnectBtn: document.getElementById('disconnect-btn'),
            sendTestBtn: document.getElementById('send-test-btn'),
            startDiscoveryBtn: document.getElementById('start-discovery-btn'),
            stopDiscoveryBtn: document.getElementById('stop-discovery-btn'),
            getDevicesBtn: document.getElementById('get-devices-btn'),
            sendDeviceInfoBtn: document.getElementById('send-device-info-btn'),
            sendCustomBtn: document.getElementById('send-custom-btn'),
            sendControlBtn: document.getElementById('send-control-btn'),
            logArea: document.getElementById('log-area'),
            messageContent: document.getElementById('message-content'),
            messageType: document.getElementById('message-type'),
            targetDevice: document.getElementById('target-device'),
            commandType: document.getElementById('command-type'),
            discoveredDevices: document.getElementById('discovered-devices')
        };
        
        // 日志记录函数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}">${message}</span>`;
            elements.logArea.appendChild(logEntry);
            elements.logArea.scrollTop = elements.logArea.scrollHeight;
        }
        
        // 检查服务器状态
        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:8928/api/status');
                if (response.ok) {
                    const data = await response.json();
                    elements.serverStatus.className = 'status success';
                    elements.serverStatus.innerHTML = `✅ 服务器运行正常 - Android连接: ${data.androidConnected ? '是' : '否'}, 客户端数: ${data.totalClients}, 时间戳: ${new Date(data.timestamp).toLocaleString()}`;
                } else {
                    elements.serverStatus.className = 'status error';
                    elements.serverStatus.innerHTML = `❌ 服务器未响应 - 状态码: ${response.status}`;
                }
            } catch (error) {
                elements.serverStatus.className = 'status error';
                elements.serverStatus.innerHTML = `❌ 服务器连接失败 - ${error.message}`;
            }
        }
        
        // 连接到WebSocket服务器
        function connectToServer() {
            // 根据当前页面URL决定WebSocket连接地址
            const isViteDevServer = window.location.port === '8781';
            const wsUrl = isViteDevServer ? 'ws://localhost:8781/ws' : 'ws://localhost:8928';
            
            log(`尝试连接到: ${wsUrl}`);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                log('WebSocket连接已建立', 'success');
                isConnected = true;
                elements.websocketStatus.className = 'status success';
                elements.websocketStatus.textContent = '已连接到服务器';
                elements.connectBtn.disabled = true;
                elements.disconnectBtn.disabled = false;
            };
            
            ws.onclose = function(event) {
                log('WebSocket连接已关闭', 'info');
                isConnected = false;
                elements.websocketStatus.className = 'status info';
                elements.websocketStatus.textContent = '已断开连接';
                elements.connectBtn.disabled = false;
                elements.disconnectBtn.disabled = true;
            };
            
            ws.onerror = function(error) {
                log(`WebSocket连接错误: ${error.message}`, 'error');
                elements.websocketStatus.className = 'status error';
                elements.websocketStatus.textContent = '连接错误';
            };
            
            ws.onmessage = function(event) {
                log(`收到消息: ${event.data.substring(0, 100)}${event.data.length > 100 ? '...' : ''}`, 'success');
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (e) {
                    log(`消息解析失败: ${e.message}`, 'error');
                }
            };
        }
        
        // 处理接收到的消息
        function handleMessage(message) {
            switch (message.type) {
                case 'connection_established':
                    log(`连接已建立 - 客户端ID: ${message.clientId}`, 'success');
                    break;
                case 'device_found':
                    handleDeviceFound(message.device);
                    break;
                case 'android_connected':
                    log(`Android设备已连接: ${message.deviceInfo.deviceName}`, 'success');
                    break;
                case 'android_disconnected':
                    log('Android设备已断开连接', 'info');
                    break;
                case 'screen_frame':
                    log('收到屏幕帧数据', 'info');
                    break;
                case 'file_transfer':
                    log(`文件传输: ${message.action}`, 'info');
                    break;
                case 'clipboard':
                    log(`剪贴板同步: ${message.data.substring(0, 50)}...`, 'info');
                    break;
                case 'notification':
                    log(`通知: ${message.title}`, 'info');
                    break;
                case 'heartbeat':
                    log('收到心跳响应', 'info');
                    break;
                case 'error':
                    log(`服务器错误: ${message.message}`, 'error');
                    break;
                case 'start_device_discovery_response':
                    log(`开始设备发现: ${message.success ? '成功' : '失败'}`, message.success ? 'success' : 'error');
                    break;
                case 'stop_device_discovery_response':
                    log(`停止设备发现: ${message.success ? '成功' : '失败'}`, message.success ? 'success' : 'error');
                    break;
                case 'get_discovered_devices_response':
                    log(`获取设备列表: ${message.success ? '成功' : '失败'}`, message.success ? 'success' : 'error');
                    if (message.success) {
                        log(`发现设备数量: ${message.devices.length}`, 'info');
                        updateDiscoveredDevicesList(message.devices);
                    }
                    break;
                default:
                    log(`未知消息类型: ${message.type}`, 'info');
                    break;
            }
        }
        
        // 处理发现的设备
        function handleDeviceFound(device) {
            discoveredDevices[device.deviceId] = device;
            log(`发现设备: ${device.deviceName} (${device.ip})`, 'success');
            updateDiscoveredDevicesList(Object.values(discoveredDevices));
        }
        
        // 更新发现的设备列表显示
        function updateDiscoveredDevicesList(devices) {
            elements.discoveredDevices.innerHTML = '<h3>已发现的设备:</h3>';
            if (devices.length === 0) {
                elements.discoveredDevices.innerHTML += '<p>没有发现设备</p>';
                return;
            }
            
            devices.forEach(device => {
                const deviceDiv = document.createElement('div');
                deviceDiv.className = 'device-info';
                deviceDiv.innerHTML = `
                    <strong>${device.deviceName}</strong><br>
                    ID: ${device.deviceId}<br>
                    IP: ${device.ip}<br>
                    平台: ${device.platform || 'unknown'}<br>
                    最后发现: ${new Date(device.lastSeen || Date.now()).toLocaleString()}
                `;
                elements.discoveredDevices.appendChild(deviceDiv);
            });
        }
        
        // 发送测试消息
        function sendTestMessage() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }
            
            const message = {
                type: 'test_message',
                content: 'Hello from test client',
                timestamp: Date.now()
            };
            
            ws.send(JSON.stringify(message));
            log('测试消息已发送', 'success');
        }
        
        // 发送设备信息
        function sendDeviceInfo() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }
            
            const deviceInfo = {
                platform: 'web_test_client',
                deviceName: 'Test Client ' + new Date().toLocaleTimeString(),
                deviceId: 'web-test-' + Date.now(),
                capabilities: ['test', 'web']
            };
            
            const message = {
                type: 'device_info',
                deviceInfo: deviceInfo
            };
            
            ws.send(JSON.stringify(message));
            log('设备信息已发送', 'success');
        }
        
        // 开始设备发现
        function startDeviceDiscovery() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }
            
            const message = {
                type: 'start_device_discovery'
            };
            
            ws.send(JSON.stringify(message));
            log('设备发现请求已发送', 'success');
        }
        
        // 停止设备发现
        function stopDeviceDiscovery() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }
            
            const message = {
                type: 'stop_device_discovery'
            };
            
            ws.send(JSON.stringify(message));
            log('停止设备发现请求已发送', 'success');
        }
        
        // 获取设备列表
        function getDevices() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }
            
            const message = {
                type: 'get_discovered_devices'
            };
            
            ws.send(JSON.stringify(message));
            log('获取设备列表请求已发送', 'success');
        }
        
        // 发送自定义消息
        function sendCustomMessage() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }
            
            const messageType = elements.messageType.value;
            const content = elements.messageContent.value;
            
            if (!content) {
                log('请输入消息内容', 'error');
                return;
            }
            
            let message = {};
            switch (messageType) {
                case 'control_command':
                    message = {
                        type: 'control_command',
                        commandType: 'tap',
                        x: 100,
                        y: 100,
                        deviceId: elements.targetDevice.value || null
                    };
                    break;
                case 'file_transfer':
                    message = {
                        type: 'file_transfer',
                        action: 'send',
                        fileName: 'test.txt',
                        fileSize: 1024,
                        content: content
                    };
                    break;
                case 'clipboard':
                    message = {
                        type: 'clipboard',
                        action: 'sync',
                        data: content
                    };
                    break;
                case 'notification':
                    message = {
                        type: 'notification',
                        action: 'show',
                        title: '测试通知',
                        content: content
                    };
                    break;
                case 'heartbeat':
                    message = {
                        type: 'heartbeat',
                        timestamp: Date.now()
                    };
                    break;
                default:
                    message = {
                        type: messageType,
                        content: content
                    };
            }
            
            ws.send(JSON.stringify(message));
            log(`自定义消息已发送: ${JSON.stringify(message)}`, 'success');
        }
        
        // 发送控制命令
        function sendControlCommand() {
            if (!isConnected) {
                log('请先连接到服务器', 'error');
                return;
            }
            
            const commandType = elements.commandType.value;
            const targetDevice = elements.targetDevice.value;
            
            let command = {};
            switch (commandType) {
                case 'tap':
                    command = {
                        type: 'control_command',
                        commandType: 'tap',
                        x: 100,
                        y: 100,
                        deviceId: targetDevice || null
                    };
                    break;
                case 'swipe':
                    command = {
                        type: 'control_command',
                        commandType: 'swipe',
                        startX: 100,
                        startY: 100,
                        endX: 200,
                        endY: 200,
                        deviceId: targetDevice || null
                    };
                    break;
                case 'key':
                    command = {
                        type: 'control_command',
                        commandType: 'key',
                        keyCode: 65, // A键
                        key: 'a',
                        deviceId: targetDevice || null
                    };
                    break;
                case 'text':
                    command = {
                        type: 'control_command',
                        commandType: 'text',
                        text: 'Hello from web client',
                        deviceId: targetDevice || null
                    };
                    break;
            }
            
            ws.send(JSON.stringify(command));
            log(`控制命令已发送: ${JSON.stringify(command)}`, 'success');
        }
        
        // 断开连接
        function disconnect() {
            if (ws) {
                ws.close();
                log('正在断开连接...', 'info');
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            elements.connectBtn.addEventListener('click', connectToServer);
            elements.disconnectBtn.addEventListener('click', disconnect);
            elements.sendTestBtn.addEventListener('click', sendTestMessage);
            elements.startDiscoveryBtn.addEventListener('click', startDeviceDiscovery);
            elements.stopDiscoveryBtn.addEventListener('click', stopDeviceDiscovery);
            elements.getDevicesBtn.addEventListener('click', getDevices);
            elements.sendDeviceInfoBtn.addEventListener('click', sendDeviceInfo);
            elements.sendCustomBtn.addEventListener('click', sendCustomMessage);
            elements.sendControlBtn.addEventListener('click', sendControlCommand);
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成，开始检查服务器状态...', 'info');
            checkServerStatus();
            setupEventListeners();
            elements.disconnectBtn.disabled = true;
        });
    </script>
</body>
</html>