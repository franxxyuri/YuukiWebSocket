<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows-Android Connect</title>
    

    <style>

        body {

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            margin: 0;

            padding: 20px;

            background-color: #f5f5f5;

        }

        

        .container {

            max-width: 1200px;

            margin: 0 auto;

        }

        

        header {

            text-align: center;

            margin-bottom: 30px;

        }

        

        h1 {

            color: #333;

        }

        

        .status-bar {

            background-color: #fff;

            padding: 15px;

            border-radius: 8px;

            box-shadow: 0 2px 4px rgba(0,0,0,0.1);

            margin-bottom: 20px;

        }

        

        .device-list {

            display: flex;

            flex-wrap: wrap;

            gap: 20px;

            margin-bottom: 30px;

        }

        

        .device-card {

            background-color: #fff;

            border-radius: 8px;

            padding: 20px;

            box-shadow: 0 2px 4px rgba(0,0,0,0.1);

            flex: 1;

            min-width: 300px;

        }

        

        .device-card h3 {

            margin-top: 0;

            color: #333;

        }

        

        .device-card.connected {

            border-left: 5px solid #4CAF50;

        }

        

        .device-card.disconnected {

            border-left: 5px solid #f44336;

        }

        

        .controls {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));

            gap: 20px;

            margin-bottom: 30px;

        }

        

        .control-panel {

            background-color: #fff;

            border-radius: 8px;

            padding: 20px;

            box-shadow: 0 2px 4px rgba(0,0,0,0.1);

        }

        

        .control-panel h3 {

            margin-top: 0;

            color: #333;

        }

        

        .button-group {

            display: flex;

            flex-wrap: wrap;

            gap: 10px;

            margin-bottom: 15px;

        }

        

        button {

            padding: 10px 15px;

            border: none;

            border-radius: 4px;

            cursor: pointer;

            font-weight: bold;

            transition: background-color 0.3s;

        }

        

        .btn-primary {

            background-color: #2196F3;

            color: white;

        }

        

        .btn-primary:hover {

            background-color: #1976D2;

        }

        

        .btn-success {

            background-color: #4CAF50;

            color: white;

        }

        

        .btn-success:hover {

            background-color: #388E3C;

        }

        

        .btn-danger {

            background-color: #f44336;

            color: white;

        }

        

        .btn-danger:hover {

            background-color: #D32F2F;

        }

        

        .btn-warning {

            background-color: #FF9800;

            color: white;

        }

        

        .btn-warning:hover {

            background-color: #F57C00;

        }

        

        .screen-display {

            background-color: #000;

            border-radius: 8px;

            overflow: hidden;

            position: relative;

            min-height: 400px;

            display: flex;

            align-items: center;

            justify-content: center;

            color: white;

        }

        

        .screen-placeholder {

            text-align: center;

        }

        

        .progress-bar {

            width: 100%;

            height: 20px;

            background-color: #e0e0e0;

            border-radius: 10px;

            overflow: hidden;

            margin-top: 10px;

        }

        

        .progress-fill {

            height: 100%;

            background-color: #4CAF50;

            width: 0%;

            transition: width 0.3s;

        }

        

        .log-area {

            background-color: #fff;

            border-radius: 8px;

            padding: 20px;

            box-shadow: 0 2px 4px rgba(0,0,0,0.1);

            height: 200px;

            overflow-y: auto;

            font-family: monospace;

            font-size: 14px;

        }

        

        .log-entry {

            margin-bottom: 5px;

        }

        

        .log-info {

            color: #2196F3;

        }

        

        .log-success {

            color: #4CAF50;

        }

        

        .log-error {

            color: #f44336;

        }

        

        .log-warning {

            color: #FF9800;

        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Windows-Android Connect</h1>
            <p>å±€åŸŸç½‘å†…çš„è®¾å¤‡äº’è”å·¥å…·</p>
        </header>
        
        <div class="status-bar">
            <h2>è¿æ¥çŠ¶æ€</h2>
            <p id="local-ip-display">æ­£åœ¨è·å–æœ¬æœºIPåœ°å€...</p>
            <p id="connection-status">æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨...</p>
        </div>
        
        <div class="device-list">
            <div class="device-card disconnected" id="android-device">
                <h3>Androidè®¾å¤‡</h3>
                <p>çŠ¶æ€: <span id="android-status">æœªè¿æ¥</span></p>
                <p>è®¾å¤‡åç§°: <span id="android-name">-</span></p>
                <p>IPåœ°å€: <span id="android-ip">-</span></p>
            </div>
            
            <div class="device-card disconnected" id="windows-device">
                <h3>Windowsè®¾å¤‡</h3>
                <p>çŠ¶æ€: <span id="windows-status">å·²è¿æ¥</span></p>
                <p>è®¾å¤‡åç§°: <span id="windows-name">-</span></p>
                <p>IPåœ°å€: <span id="windows-ip">-</span></p>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-panel">
                <h3>è®¾å¤‡æ§åˆ¶</h3>
                <div class="button-group">
                    <button class="btn-primary" id="connect-btn">è¿æ¥è®¾å¤‡</button>
                    <button class="btn-danger" id="disconnect-btn">æ–­å¼€è¿æ¥</button>
                </div>
                
                <h3>æ–‡ä»¶ä¼ è¾“</h3>
                <div class="button-group">
                    <button class="btn-primary" id="send-file-btn">å‘é€æ–‡ä»¶</button>
                    <button class="btn-warning" id="receive-file-btn">æ¥æ”¶æ–‡ä»¶</button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="file-progress"></div>
                </div>
                <p>ä¼ è¾“è¿›åº¦: <span id="progress-text">0%</span></p>
            </div>
            
            <div class="control-panel">
                <h3>è¿œç¨‹æ§åˆ¶</h3>
                <div class="button-group">
                    <button class="btn-primary" id="mouse-mode-btn">é¼ æ ‡æ¨¡å¼</button>
                    <button class="btn-warning" id="keyboard-mode-btn">é”®ç›˜æ¨¡å¼</button>
                </div>
                <p>æ§åˆ¶çŠ¶æ€: <span id="control-status">æœªæ¿€æ´»</span></p>
                
                <h3>åŒæ­¥åŠŸèƒ½</h3>
                <div class="button-group">
                    <button class="btn-success" id="clipboard-sync-btn">åŒæ­¥å‰ªè´´æ¿</button>
                    <button class="btn-primary" id="notification-btn">æŸ¥çœ‹é€šçŸ¥</button>
                </div>
            </div>
        </div>
        
        <div class="control-panel">
            <h3>å±å¹•æŠ•å±</h3>
            <div class="screen-display">
                <div class="screen-placeholder" id="screen-placeholder">
                    <p>å±å¹•æŠ•å±åŒºåŸŸ</p>
                    <p>è¿æ¥è®¾å¤‡åå°†æ˜¾ç¤ºAndroidå±å¹•</p>
                </div>
                <canvas id="screen-canvas" style="display: none; width: 100%; height: 100%;"></canvas>
            </div>
            <div class="button-group">
                <button class="btn-success" id="start-screen-btn">å¼€å§‹æŠ•å±</button>
                <button class="btn-danger" id="stop-screen-btn">åœæ­¢æŠ•å±</button>
            </div>
        </div>
        
        <div class="control-panel">
            <h3>ç³»ç»Ÿæ—¥å¿—</h3>
            <div class="log-area" id="log-area">
                <div class="log-entry log-info">ç³»ç»Ÿå¯åŠ¨ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // WebSocketè¿æ¥
        let ws = null;
        let androidDevice = null;
        
        // DOMå…ƒç´ 
        const elements = {
            localIpDisplay: document.getElementById('local-ip-display'),
            connectionStatus: document.getElementById('connection-status'),
            androidStatus: document.getElementById('android-status'),
            androidName: document.getElementById('android-name'),
            androidIp: document.getElementById('android-ip'),
            windowsName: document.getElementById('windows-name'),
            windowsIp: document.getElementById('windows-ip'),
            connectBtn: document.getElementById('connect-btn'),
            disconnectBtn: document.getElementById('disconnect-btn'),
            sendFileBtn: document.getElementById('send-file-btn'),
            receiveFileBtn: document.getElementById('receive-file-btn'),
            fileProgress: document.getElementById('file-progress'),
            progressText: document.getElementById('progress-text'),
            mouseModeBtn: document.getElementById('mouse-mode-btn'),
            keyboardModeBtn: document.getElementById('keyboard-mode-btn'),
            controlStatus: document.getElementById('control-status'),
            clipboardSyncBtn: document.getElementById('clipboard-sync-btn'),
            notificationBtn: document.getElementById('notification-btn'),
            startScreenBtn: document.getElementById('start-screen-btn'),
            stopScreenBtn: document.getElementById('stop-screen-btn'),
            screenPlaceholder: document.getElementById('screen-placeholder'),
            screenCanvas: document.getElementById('screen-canvas'),
            logArea: document.getElementById('log-area')
        };
        
        function connectToServer() {

            // æ ¹æ®å½“å‰é¡µé¢URLå†³å®šWebSocketè¿æ¥åœ°å€
            const isViteDevServer = window.location.port === '8781' || window.location.port === '9781';
            const isMainServer = window.location.port === '8928' || window.location.port === '9928';
            let wsUrl;

            if (isViteDevServer) {
                // Viteå¼€å‘æœåŠ¡å™¨
                wsUrl = 'ws://localhost:' + window.location.port + '/ws';
            } else if (isMainServer) {
                // ä¸»æœåŠ¡å™¨
                wsUrl = 'ws://' + window.location.hostname + ':' + window.location.port;
            } else {
                // é»˜è®¤ä½¿ç”¨ä¸»æœåŠ¡å™¨ç«¯å£ - ä¿®å¤ï¼šç§»é™¤process.envå¼•ç”¨ï¼Œä½¿ç”¨å…·ä½“çš„ç«¯å£
                const defaultPort = window.location.hostname.includes('9928') ? '9928' : '8928';
                wsUrl = 'ws://' + window.location.hostname + ':' + defaultPort;
            }

            // ä½¿ç”¨åŸç”ŸWebSocketè¿æ¥
            ws = new WebSocket(wsUrl);



            ws.onopen = function(event) {

                log('å·²è¿æ¥åˆ°æœåŠ¡å™¨: ' + wsUrl, 'success');

                elements.connectionStatus.textContent = 'å·²è¿æ¥åˆ°æœåŠ¡å™¨: ' + wsUrl;

                elements.connectionStatus.style.color = '#4CAF50';

                

                // å‘é€è®¾å¤‡ä¿¡æ¯ï¼ˆæ¨¡æ‹ŸWebå®¢æˆ·ç«¯ï¼‰

                ws.send(JSON.stringify({

                    type: 'device_info',

                    deviceInfo: {

                        platform: 'web',

                        deviceName: 'Screen Stream Web Client',

                        deviceId: 'web-screen-' + Date.now()

                    }

                }));

            };



            ws.onclose = function(event) {

                log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥: ' + wsUrl, 'error');

                elements.connectionStatus.textContent = 'ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥: ' + wsUrl;

                elements.connectionStatus.style.color = '#f44336';

            };



            ws.onerror = function(error) {

                log('WebSocketè¿æ¥é”™è¯¯: ' + error.message + ' (URL: ' + wsUrl + ')', 'error');

            };



            ws.onmessage = function(event) {

                try {

                    const message = JSON.parse(event.data);

                    handleMessage(message);

                } catch (e) {

                    log('æ¶ˆæ¯è§£æé”™è¯¯: ' + e.message, 'error');

                }

            };

        }
        
                // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯

        function handleMessage(message) {

            switch (message.type) {

                case 'connection_established':

                    log('è¿æ¥å·²å»ºç«‹ï¼Œå®¢æˆ·ç«¯ID: ' + message.clientId, 'success');

                    break;

                    

                case 'device_connected':

                    handleDeviceConnected(message.deviceInfo);

                    break;

                    

                case 'screen_frame':

                    handleScreenFrame(message);

                    break;

                    

                case 'file_transfer':

                    handleFileTransfer(message);

                    break;

                    

                case 'clipboard':

                    handleClipboard(message);

                    break;

                    

                case 'notification':

                    handleNotification(message);

                    break;

                    

                default:

                    log('æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯ç±»å‹: ' + message.type, 'warning');

                    break;

            }

        }
        
        // å¤„ç†è®¾å¤‡è¿æ¥
        function handleDeviceConnected(deviceInfo) {
            if (deviceInfo.platform === 'android') {
                androidDevice = deviceInfo;
                
                elements.androidStatus.textContent = 'å·²è¿æ¥';
                elements.androidStatus.style.color = '#4CAF50';
                elements.androidName.textContent = deviceInfo.deviceName;
                elements.androidIp.textContent = deviceInfo.ip;
                
                document.getElementById('android-device').className = 'device-card connected';
                
                log('Androidè®¾å¤‡å·²è¿æ¥: ' + deviceInfo.deviceName, 'success');
            }
        }
        
        // å¤„ç†å±å¹•å¸§
        function handleScreenFrame(message) {
            // ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦è§£ç å›¾åƒæ•°æ®
            log('æ”¶åˆ°å±å¹•å¸§æ•°æ®', 'info');
        }
        
        // å¤„ç†æ–‡ä»¶ä¼ è¾“
        function handleFileTransfer(message) {
            switch (message.action) {
                case 'start':
                    log('å¼€å§‹æ–‡ä»¶ä¼ è¾“: ' + message.fileName, 'info');
                    break;
                case 'chunk':
                    updateProgress(message.progress);
                    break;
                case 'complete':
                    log('æ–‡ä»¶ä¼ è¾“å®Œæˆ: ' + message.fileName, 'success');
                    updateProgress(100);
                    break;
                case 'error':
                    log('æ–‡ä»¶ä¼ è¾“é”™è¯¯: ' + message.error, 'error');
                    break;
            }
        }
        
        // å¤„ç†å‰ªè´´æ¿åŒæ­¥
        function handleClipboard(message) {
            log('å‰ªè´´æ¿å†…å®¹å·²åŒæ­¥: ' + message.data.substring(0, 50) + '...', 'info');
        }
        
        // å¤„ç†é€šçŸ¥
        function handleNotification(message) {
            if (message.action === 'posted') {
                log('æ”¶åˆ°é€šçŸ¥: ' + message.title, 'info');
            }
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            elements.fileProgress.style.width = percent + '%';
            elements.progressText.textContent = percent + '%';
        }
        
        // å‘é€æ§åˆ¶å‘½ä»¤

        function sendControlCommand(command) {

            if (!ws || ws.readyState !== WebSocket.OPEN) {

                log('WebSocketæœªè¿æ¥', 'error');

                return;

            }

            

            if (!androidDevice) {

                log('æ²¡æœ‰è¿æ¥çš„Androidè®¾å¤‡', 'error');

                return;

            }

            

            const message = {

                type: 'control_command',

                ...command

            };

            

            ws.send(JSON.stringify(message));

            log('å‘é€æ§åˆ¶å‘½ä»¤: ' + command.commandType, 'info');

        }
        
        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-' + type;
            logEntry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + message;
            
            elements.logArea.appendChild(logEntry);
            elements.logArea.scrollTop = elements.logArea.scrollHeight;
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è¿æ¥/æ–­å¼€è¿æ¥æŒ‰é’®
            elements.connectBtn.addEventListener('click', function() {
                log('æ­£åœ¨æœç´¢Androidè®¾å¤‡...', 'info');
                // å®é™…åº”ç”¨ä¸­ä¼šå‘é€è®¾å¤‡å‘ç°è¯·æ±‚
            });
            
            elements.disconnectBtn.addEventListener('click', function() {
                if (androidDevice) {
                    log('å·²æ–­å¼€ä¸ ' + androidDevice.deviceName + ' çš„è¿æ¥', 'info');
                    androidDevice = null;
                    elements.androidStatus.textContent = 'æœªè¿æ¥';
                    elements.androidStatus.style.color = '#f44336';
                    elements.androidName.textContent = '-';
                    elements.androidIp.textContent = '-';
                    document.getElementById('android-device').className = 'device-card disconnected';
                }
            });
            
            // æ–‡ä»¶ä¼ è¾“æŒ‰é’®
            elements.sendFileBtn.addEventListener('click', function() {
                if (!androidDevice) {
                    log('è¯·å…ˆè¿æ¥Androidè®¾å¤‡', 'error');
                    return;
                }
                log('é€‰æ‹©æ–‡ä»¶è¿›è¡Œä¼ è¾“...', 'info');
                // å®é™…åº”ç”¨ä¸­ä¼šæ‰“å¼€æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
            });
            
            elements.receiveFileBtn.addEventListener('click', function() {
                if (!androidDevice) {
                    log('è¯·å…ˆè¿æ¥Androidè®¾å¤‡', 'error');
                    return;
                }
                log('å‡†å¤‡æ¥æ”¶æ–‡ä»¶...', 'info');
            });
            
            // è¿œç¨‹æ§åˆ¶æŒ‰é’®
            elements.mouseModeBtn.addEventListener('click', function() {
                elements.controlStatus.textContent = 'é¼ æ ‡æ¨¡å¼å·²æ¿€æ´»';
                log('æ¿€æ´»é¼ æ ‡æ§åˆ¶æ¨¡å¼', 'info');
            });
            
            elements.keyboardModeBtn.addEventListener('click', function() {
                elements.controlStatus.textContent = 'é”®ç›˜æ¨¡å¼å·²æ¿€æ´»';
                log('æ¿€æ´»é”®ç›˜æ§åˆ¶æ¨¡å¼', 'info');
            });
            
            // åŒæ­¥åŠŸèƒ½æŒ‰é’®
            elements.clipboardSyncBtn.addEventListener('click', function() {
                log('åŒæ­¥å‰ªè´´æ¿å†…å®¹...', 'info');
                // å®é™…åº”ç”¨ä¸­ä¼šå‘é€å‰ªè´´æ¿åŒæ­¥è¯·æ±‚
            });
            
            elements.notificationBtn.addEventListener('click', function() {
                log('æŸ¥çœ‹é€šçŸ¥å†å²...', 'info');
            });
            
            // å±å¹•æŠ•å±æŒ‰é’®
            elements.startScreenBtn.addEventListener('click', function() {
                if (!androidDevice) {
                    log('è¯·å…ˆè¿æ¥Androidè®¾å¤‡', 'error');
                    return;
                }
                
                // å‘é€å¼€å§‹å±å¹•æŠ•å±å‘½ä»¤
                sendControlCommand({
                    commandType: 'screen_stream',
                    action: 'start'
                });
                
                elements.screenPlaceholder.style.display = 'none';
                elements.screenCanvas.style.display = 'block';
                log('å¼€å§‹å±å¹•æŠ•å±...', 'info');
            });
            
            elements.stopScreenBtn.addEventListener('click', function() {
                // å‘é€åœæ­¢å±å¹•æŠ•å±å‘½ä»¤
                sendControlCommand({
                    commandType: 'screen_stream',
                    action: 'stop'
                });
                
                elements.screenPlaceholder.style.display = 'block';
                elements.screenCanvas.style.display = 'none';
                log('åœæ­¢å±å¹•æŠ•å±', 'info');
            });
        }
        
        // è·å–æœ¬åœ°IPåœ°å€
        async function getLocalIP() {
            try {
                // ä½¿ç”¨WebRTC APIè·å–æœ¬åœ°IPåœ°å€
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.createDataChannel('');
                pc.createOffer()
                    .then(offer => pc.setLocalDescription(offer))
                    .catch(() => {});
                
                pc.onicecandidate = (ice) => {
                    if (ice && ice.candidate && ice.candidate.candidate) {
                        const myIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate)[1];
                        
                        if (myIP && !myIP.startsWith('192.168.1') && !myIP.startsWith('10.') && !myIP.startsWith('172.')) {
                            // è¿™æ˜¯ä¸€ä¸ªå…¬ç½‘IPï¼Œè·³è¿‡
                        } else {
                            // è¿™æ˜¯ä¸€ä¸ªå±€åŸŸç½‘IP
                            elements.localIpDisplay.textContent = `ğŸ’» æœ¬æœºIPåœ°å€: ${myIP} (ç«¯å£ 8928)`;
                        }
                    }
                };
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´æ”¶é›†IPåœ°å€
                setTimeout(() => {
                    pc.close();
                    if (!elements.localIpDisplay.textContent.includes('192.168')) {
                        // å¦‚æœWebRTCæ–¹æ³•å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤IP
                        elements.localIpDisplay.textContent = `ğŸ’» æœ¬æœºIPåœ°å€: 192.168.124.18 (ç«¯å£ 8928) - è¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´`;
                    }
                }, 1000);
            } catch (error) {
                // å¦‚æœWebRTCæ–¹æ³•å¤±è´¥ï¼Œæ˜¾ç¤ºç”¨æˆ·æŒ‡å®šçš„IP
                elements.localIpDisplay.textContent = `ğŸ’» æœ¬æœºIPåœ°å€: 192.168.124.18 (ç«¯å£ 8928) - è¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´`;
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function init() {
            log('åº”ç”¨å¯åŠ¨ä¸­...', 'info');
            
            // è·å–æœ¬åœ°IPåœ°å€
            getLocalIP();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // è¿æ¥åˆ°æœåŠ¡å™¨
            connectToServer();
            
            // è·å–Windowsè®¾å¤‡ä¿¡æ¯
            elements.windowsName.textContent = navigator.platform;
            elements.windowsIp.textContent = window.location.hostname || '192.168.124.18';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>