<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç®¡ç†å™¨ - Windows-Android Connect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: 70px; /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        }
        
        .modern-navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 70px;
        }
        
        .nav-logo {
            display: flex;
            align-items: center;
        }
        
        .nav-logo a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: white;
            font-weight: 600;
            font-size: 1.3rem;
        }
        
        .nav-logo-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.85);
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.25);
        }
        
        .nav-icon {
            margin-right: 8px;
            font-size: 1.1rem;
        }
        
        .nav-text {
            font-size: 0.95rem;
        }
        
        .nav-toggle {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 5px;
        }
        
        .bar {
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 3px 0;
            transition: 0.3s;
            border-radius: 2px;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        @media screen and (max-width: 768px) {
            .nav-menu {
                position: fixed;
                left: -100%;
                top: 70px;
                flex-direction: column;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                width: 100%;
                text-align: center;
                transition: 0.3s;
                box-shadow: 0 10px 27px rgba(0, 0, 0, 0.05);
                padding: 20px 0;
            }
            
            .nav-menu.active {
                left: 0;
            }
            
            .nav-link {
                padding: 15px;
                margin: 5px 20px;
                display: flex;
                justify-content: center;
            }
            
            .nav-toggle {
                display: flex;
            }
            
            .nav-toggle.active .bar:nth-child(2) {
                opacity: 0;
            }
            
            .nav-toggle.active .bar:nth-child(1) {
                transform: translateY(8px) rotate(45deg);
            }
            
            .nav-toggle.active .bar:nth-child(3) {
                transform: translateY(-8px) rotate(-45deg);
            }
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .local-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        input, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input {
            flex: 1;
            min-width: 250px;
        }
        
        button {
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1976D2;
        }
        
        .btn-success {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #388E3C;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #D32F2F;
        }
        
        .btn-warning {
            background-color: #FF9800;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #F57C00;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .device-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .device-card.connected {
            border-left: 5px solid #4CAF50;
        }
        
        .device-card.disconnected {
            border-left: 5px solid #f44336;
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .device-name {
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .device-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-connected {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-disconnected {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .device-details {
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }
        
        .device-actions {
            margin-top: 15px;
            display: flex;
            gap: 5px;
        }
        
        .device-actions button {
            flex: 1;
            padding: 6px;
            font-size: 12px;
        }
        
        .connection-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .log-container {
            margin-top: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .log-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .log-area {
            height: 150px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 3px;
        }
        
        .log-time {
            color: #999;
            margin-right: 5px;
        }
        
        .log-info { color: #2196F3; }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-warning { color: #FF9800; }
    </style>
</head>
<body>
    <!-- ç°ä»£åŒ–å¯¼èˆªæ  -->
    <nav class="modern-navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="/">
                    <span class="nav-logo-icon">ğŸ”—</span>
                    <span class="nav-logo-text">Windows-Android Connect</span>
                </a>
            </div>
            
            <div class="nav-menu" id="nav-menu">
                <a href="/" class="nav-link" data-page="home">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">é¦–é¡µ</span>
                </a>
                <a href="/pages/app-index.html" class="nav-link" data-page="dashboard">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span class="nav-text">ä»ªè¡¨æ¿</span>
                </a>
                <a href="/pages/device-manager.html" class="nav-link active" data-page="devices">
                    <span class="nav-icon">ğŸ“±</span>
                    <span class="nav-text">è®¾å¤‡ç®¡ç†</span>
                </a>
                <a href="/pages/screen-stream.html" class="nav-link" data-page="screen">
                    <span class="nav-icon">ğŸ“º</span>
                    <span class="nav-text">å±å¹•æŠ•å±</span>
                </a>
                <a href="/pages/react-index.html" class="nav-link" data-page="react">
                    <span class="nav-icon">âš›ï¸</span>
                    <span class="nav-text">Reactåº”ç”¨</span>
                </a>
            </div>
            
            <div class="nav-toggle" id="nav-toggle">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <header>
            <h1>è®¾å¤‡ç®¡ç†å™¨</h1>
            <p>ç®¡ç†Windows-Android Connectç½‘ç»œä¸­çš„è®¾å¤‡</p>
        </header>
        
        <div class="local-info">
            <h3>æœ¬æœºä¿¡æ¯</h3>
            <div id="local-info-content">æ­£åœ¨è·å–æœ¬æœºä¿¡æ¯...</div>
        </div>
        
        <div class="search-section">
            <h2>è®¾å¤‡å‘ç°ä¸è¿æ¥</h2>
            <div class="connection-status" id="connection-status">å‡†å¤‡å°±ç»ª</div>
            
            <div class="search-controls">
                <input type="text" id="ip-input" placeholder="è¾“å…¥è®¾å¤‡IPåœ°å€ (ä¾‹å¦‚: 192.168.1.100)">
                <button class="btn-primary" id="search-ip-btn">æœç´¢IP</button>
                <button class="btn-success" id="scan-network-btn">æ‰«æå±€åŸŸç½‘</button>
                <button class="btn-warning" id="refresh-devices-btn">åˆ·æ–°è®¾å¤‡</button>
            </div>
            
            <div id="search-status"></div>
        </div>
        
        <h2>å·²å‘ç°çš„è®¾å¤‡</h2>
        <div class="devices-grid" id="devices-container">
            <div class="device-card disconnected">
                <div class="device-header">
                    <div class="device-name">æ— è®¾å¤‡</div>
                    <div class="device-status status-disconnected">ç¦»çº¿</div>
                </div>
                <div class="device-details">
                    <div>IP: -</div>
                    <div>å¹³å°: -</div>
                    <div>æœ€åæ´»åŠ¨: -</div>
                </div>
                <div class="device-actions">
                    <button class="btn-primary" disabled>è¿æ¥</button>
                    <button class="btn-danger" disabled>ç§»é™¤</button>
                </div>
            </div>
        </div>
        
        <div class="log-container">
            <div class="log-header">æ“ä½œæ—¥å¿—</div>
            <div class="log-area" id="log-area"></div>
        </div>
        
        <!-- æ–‡ä»¶ä¼ è¾“åŒºåŸŸ -->
        <div class="file-transfer-section">
            <h2>æ–‡ä»¶ä¼ è¾“</h2>
            <div class="transfer-controls">
                <button class="btn-primary" id="select-file-btn">é€‰æ‹©æ–‡ä»¶</button>
                <input type="file" id="file-input" style="display: none;">
                <button class="btn-success" id="send-file-btn" disabled>å‘é€æ–‡ä»¶</button>
                <button class="btn-warning" id="receive-file-btn" disabled>æ¥æ”¶æ–‡ä»¶</button>
            </div>
            
            <div class="selected-file-info" id="selected-file-info">æœªé€‰æ‹©æ–‡ä»¶</div>
            
            <div class="transfer-progress-container">
                <div class="progress-bar" id="transfer-progress-bar">
                    <div class="progress-fill" id="transfer-progress-fill"></div>
                </div>
                <div class="progress-info" id="transfer-progress-info">0%</div>
            </div>
            
            <div class="transfer-history" id="transfer-history">
                <div class="history-header">ä¼ è¾“å†å²</div>
                <div class="history-items" id="history-items"></div>
            </div>
        </div>
    </div>

    <script>
        // DOMå…ƒç´ 
        const elements = {
            localInfoContent: document.getElementById('local-info-content'),
            connectionStatus: document.getElementById('connection-status'),
            ipInput: document.getElementById('ip-input'),
            searchIpBtn: document.getElementById('search-ip-btn'),
            scanNetworkBtn: document.getElementById('scan-network-btn'),
            refreshDevicesBtn: document.getElementById('refresh-devices-btn'),
            searchStatus: document.getElementById('search-status'),
            devicesContainer: document.getElementById('devices-container'),
            logArea: document.getElementById('log-area'),
            // æ–‡ä»¶ä¼ è¾“å…ƒç´ 
            fileInput: document.getElementById('file-input'),
            selectFileBtn: document.getElementById('select-file-btn'),
            sendFileBtn: document.getElementById('send-file-btn'),
            receiveFileBtn: document.getElementById('receive-file-btn'),
            selectedFileInfo: document.getElementById('selected-file-info'),
            transferProgressBar: document.getElementById('transfer-progress-bar'),
            transferProgressFill: document.getElementById('transfer-progress-fill'),
            transferProgressInfo: document.getElementById('transfer-progress-info'),
            transferHistory: document.getElementById('transfer-history'),
            historyItems: document.getElementById('history-items')
        };
        
        // å½“å‰è¿æ¥çš„WebSocket
        let ws = null;
        let isConnected = false;
        
        // å·²å‘ç°çš„è®¾å¤‡åˆ—è¡¨
        let discoveredDevices = {};
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;
            elements.logArea.appendChild(logEntry);
            elements.logArea.scrollTop = elements.logArea.scrollHeight;
        }
        
        // è·å–æœ¬æœºä¿¡æ¯
        function getLocalInfo() {
            // æ¨¡æ‹Ÿè·å–æœ¬æœºIPä¿¡æ¯
            elements.localInfoContent.innerHTML = `
                <div>è®¾å¤‡åç§°: ${navigator.platform} (æµè§ˆå™¨)</div>
                <div>IPåœ°å€: <span id="local-ip">è·å–ä¸­...</span></div>
                <div>WebSocketç«¯å£: 8928</div>
                <div>æœåŠ¡çŠ¶æ€: <span style="color: #4CAF50; font-weight: bold;">è¿è¡Œä¸­</span></div>
            `;
            
            // å°è¯•è·å–æœ¬æœºIP
            getLocalIP();
        }
        
        // è·å–æœ¬æœºIPåœ°å€
        async function getLocalIP() {
            try {
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.createDataChannel('');
                pc.createOffer()
                    .then(offer => pc.setLocalDescription(offer))
                    .catch(() => {});
                
                pc.onicecandidate = (ice) => {
                    if (ice && ice.candidate && ice.candidate.candidate) {
                        const myIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate)[1];
                        
                        if (myIP && !myIP.startsWith('192.168.1') && !myIP.startsWith('10.') && !myIP.startsWith('172.')) {
                            // å…¬ç½‘IP
                        } else {
                            // å±€åŸŸç½‘IP
                            document.getElementById('local-ip').textContent = myIP || '192.168.124.18';
                        }
                    }
                };
                
                setTimeout(() => {
                    pc.close();
                    // å¦‚æœWebRTCæ–¹æ³•å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    if (document.getElementById('local-ip').textContent === 'è·å–ä¸­...') {
                        document.getElementById('local-ip').textContent = '192.168.124.18';
                    }
                }, 1000);
            } catch (error) {
                document.getElementById('local-ip').textContent = '192.168.124.18';
            }
        }
        
        // æœç´¢ç‰¹å®šIPçš„è®¾å¤‡
        async function searchDeviceByIP() {
            const ip = elements.ipInput.value.trim();
            if (!ip) {
                showSearchStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€', 'error');
                return;
            }
            
            // éªŒè¯IPæ ¼å¼
            if (!validateIP(ip)) {
                showSearchStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€', 'error');
                return;
            }
            
            showSearchStatus(`æ­£åœ¨æœç´¢è®¾å¤‡: ${ip}`, 'info');
            log(`å¼€å§‹æœç´¢IP: ${ip}`, 'info');
            
            // å°è¯•è¿æ¥åˆ°è¯¥IP
            try {
                // è¿™é‡Œæ¨¡æ‹Ÿè¿æ¥æµ‹è¯• - å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦è°ƒç”¨åç«¯API
                await testDeviceConnection(ip);
                
                // æ¨¡æ‹Ÿæ‰¾åˆ°è®¾å¤‡
                const device = {
                    deviceId: `device-${ip.replace(/\./g, '-')}`,
                    deviceName: `è®¾å¤‡ (${ip})`,
                    ip: ip,
                    platform: 'Unknown',
                    lastSeen: Date.now()
                };
                
                showSearchStatus(`å·²æ‰¾åˆ°è®¾å¤‡: ${ip}`, 'success');
                log(`æ‰¾åˆ°è®¾å¤‡: ${device.deviceName}`, 'success');
                
                // æ·»åŠ åˆ°è®¾å¤‡åˆ—è¡¨
                addDeviceToList(device);
            } catch (error) {
                showSearchStatus(`æœªæ‰¾åˆ°è®¾å¤‡: ${ip}`, 'error');
                log(`æœªæ‰¾åˆ°è®¾å¤‡: ${ip}`, 'error');
            }
        }
        
        // æ‰«æå±€åŸŸç½‘ä¸­çš„è®¾å¤‡
        async function scanNetworkForDevices() {
            // è·å–æœ¬æœºIPå¹¶ç¡®å®šå­ç½‘
            const localIPText = document.getElementById('local-ip').textContent;
            if (!localIPText || localIPText === 'è·å–ä¸­...') {
                showSearchStatus('æ­£åœ¨è·å–æœ¬æœºIPï¼Œè¯·ç¨åå†è¯•', 'error');
                return;
            }
            
            const localIP = localIPText.match(/(\d+\.\d+\.\d+)\.(\d+)/);
            if (!localIP) {
                showSearchStatus('æ— æ³•ç¡®å®šå±€åŸŸç½‘å­ç½‘', 'error');
                return;
            }
            
            const subnet = localIP[1];
            showSearchStatus(`æ­£åœ¨æ‰«æå­ç½‘: ${subnet}.0/24...`, 'info');
            log(`å¼€å§‹æ‰«æå­ç½‘ ${subnet}.0/24`, 'info');
            
            // é‡ç½®è®¾å¤‡åˆ—è¡¨
            const oldDevices = { ...discoveredDevices };
            discoveredDevices = {};
            elements.devicesContainer.innerHTML = '';
            
            // æ ‡è®°ä¸ºæ­£åœ¨æ‰«æ
            isScanning = true;
            
            try {
                // 1. é¦–å…ˆå°è¯•ä»åç«¯APIè·å–è®¾å¤‡åˆ—è¡¨
                const devices = await fetchDevicesFromBackend(subnet);
                
                if (devices && devices.length > 0) {
                    // æ·»åŠ åˆ°è®¾å¤‡åˆ—è¡¨
                    devices.forEach(device => addDeviceToList(device));
                    showSearchStatus(`æ‰«æå®Œæˆï¼Œå‘ç° ${devices.length} ä¸ªè®¾å¤‡`, 'success');
                    log(`å±€åŸŸç½‘æ‰«æå®Œæˆï¼Œå‘ç° ${devices.length} ä¸ªè®¾å¤‡`, 'info');
                } else {
                    // 2. å¦‚æœAPIå¤±è´¥æˆ–æ²¡æœ‰æ‰¾åˆ°è®¾å¤‡ï¼Œä½¿ç”¨ç®€å•çš„æ¨¡æ‹Ÿè®¾å¤‡
                    log('åç«¯APIæœªå“åº”æˆ–æœªæ‰¾åˆ°è®¾å¤‡ï¼Œä½¿ç”¨æ¨¡æ‹Ÿè®¾å¤‡', 'info');
                    await simulateDeviceDiscovery(subnet);
                }
                
                // 3. æ·»åŠ ä¹‹å‰å·²è¿æ¥ä½†æœªè¢«é‡æ–°å‘ç°çš„è®¾å¤‡ï¼ˆæ ‡è®°ä¸ºç¦»çº¿ï¼‰
                Object.values(oldDevices).forEach(device => {
                    if (!discoveredDevices[device.deviceId]) {
                        device.ip = null;
                        device.connected = false;
                        device.lastSeen = Date.now();
                        addDeviceToList(device);
                    }
                });
                
                // 4. å¯åŠ¨å®šæ—¶åˆ·æ–°
                startDeviceStatusRefresh();
            } catch (error) {
                showSearchStatus(`æ‰«æå¤±è´¥: ${error.message}`, 'error');
                log(`æ‰«æå¤±è´¥: ${error.message}`, 'error');
                // å¤±è´¥æ—¶æ˜¾ç¤ºæ¨¡æ‹Ÿè®¾å¤‡ä»¥ä¾¿æµ‹è¯•
                await simulateDeviceDiscovery(subnet);
            } finally {
                isScanning = false;
            }
        }
        
        // ä»åç«¯APIè·å–è®¾å¤‡åˆ—è¡¨
        async function fetchDevicesFromBackend(subnet) {
            try {
                // å°è¯•è¿æ¥åˆ°æœ¬åœ°åç«¯æœåŠ¡
                const response = await fetch(`http://localhost:8080/api/devices/search?subnet=${subnet}`, {
                    method: 'GET',
                    timeout: 3000
                });
                
                if (response.ok) {
                    return await response.json();
                }
                // å¦‚æœå“åº”ä¸æˆåŠŸï¼Œè¿”å›null
                return null;
            } catch (error) {
                // APIè°ƒç”¨å¤±è´¥ï¼Œè¿”å›null
                return null;
            }
        }
        
        // æ¨¡æ‹Ÿè®¾å¤‡å‘ç°
        async function simulateDeviceDiscovery(subnet) {
            // æ¨¡æ‹Ÿæ‰¾åˆ°çš„è®¾å¤‡
            const mockDevices = [
                {
                    deviceId: `device-1-${Date.now()}`,
                    deviceName: 'Androidè®¾å¤‡',
                    ip: `${subnet}.101`,
                    platform: 'Android',
                    lastSeen: Date.now()
                },
                {
                    deviceId: `device-2-${Date.now()}`,
                    deviceName: 'æµ‹è¯•è®¾å¤‡',
                    ip: `${subnet}.102`,
                    platform: 'Unknown',
                    lastSeen: Date.now()
                },
                {
                    deviceId: `device-3-${Date.now()}`,
                    deviceName: 'ç¦»çº¿è®¾å¤‡',
                    ip: null,
                    platform: 'Unknown',
                    lastSeen: Date.now() - 60000 // 1åˆ†é’Ÿå‰
                }
            ];
            
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // æ·»åŠ æ¨¡æ‹Ÿè®¾å¤‡åˆ°åˆ—è¡¨
            mockDevices.forEach(device => addDeviceToList(device));
            
            showSearchStatus(`æ‰«æå®Œæˆï¼Œå‘ç° ${mockDevices.filter(d => d.ip).length} ä¸ªåœ¨çº¿è®¾å¤‡`, 'success');
        }
        
        // å¯åŠ¨è®¾å¤‡çŠ¶æ€å®šæ—¶åˆ·æ–°
        function startDeviceStatusRefresh() {
            // å¦‚æœå·²æœ‰å®šæ—¶å™¨ï¼Œå…ˆæ¸…é™¤
            if (deviceRefreshInterval) {
                clearInterval(deviceRefreshInterval);
            }
            
            // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡è®¾å¤‡çŠ¶æ€
            deviceRefreshInterval = setInterval(async () => {
                if (isScanning) return; // å¦‚æœæ­£åœ¨æ‰«æï¼Œè·³è¿‡
                
                try {
                    // å°è¯•ä»åç«¯è·å–æœ€æ–°è®¾å¤‡çŠ¶æ€
                    const devices = await fetchDevicesFromBackend('');
                    if (devices && devices.length > 0) {
                        devices.forEach(device => {
                            if (discoveredDevices[device.deviceId]) {
                                // æ›´æ–°è®¾å¤‡çŠ¶æ€
                                Object.assign(discoveredDevices[device.deviceId], device);
                                updateDeviceInList(device);
                            }
                        });
                    }
                } catch (error) {
                    // åˆ·æ–°å¤±è´¥ï¼Œé™é»˜å¤„ç†
                }
                
                // æ›´æ–°æ‰€æœ‰è®¾å¤‡çš„æœ€åæ´»åŠ¨æ—¶é—´
                Object.values(discoveredDevices).forEach(device => {
                    updateDeviceActivity(device);
                });
            }, 30000);
        }
        
        // æ›´æ–°è®¾å¤‡æ´»åŠ¨çŠ¶æ€
        function updateDeviceActivity(device) {
            if (!device.ip) {
                // ç¦»çº¿è®¾å¤‡ï¼Œæ£€æŸ¥æ˜¯å¦åº”è¯¥ç§»é™¤
                const timeSinceLastSeen = Date.now() - device.lastSeen;
                if (timeSinceLastSeen > 300000) { // 5åˆ†é’Ÿ
                    log(`è®¾å¤‡ ${device.deviceName} é•¿æ—¶é—´ç¦»çº¿ï¼Œå·²ç§»é™¤`, 'info');
                    removeDevice(device.deviceId);
                }
            }
        }
        
        // æœç´¢ç‰¹å®šIPçš„è®¾å¤‡
        async function searchDeviceByIP() {
            const ip = elements.ipInput.value.trim();
            if (!ip) {
                showSearchStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€', 'error');
                return;
            }
            
            // éªŒè¯IPæ ¼å¼
            if (!validateIP(ip)) {
                showSearchStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€', 'error');
                return;
            }
            
            showSearchStatus(`æ­£åœ¨æœç´¢è®¾å¤‡: ${ip}`, 'info');
            log(`å¼€å§‹æœç´¢IP: ${ip}`, 'info');
            
            // å°è¯•è¿æ¥åˆ°è¯¥IP
            try {
                // è¿™é‡Œæ¨¡æ‹Ÿè¿æ¥æµ‹è¯• - å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦è°ƒç”¨åç«¯API
                await testDeviceConnection(ip);
                
                // æ¨¡æ‹Ÿæ‰¾åˆ°è®¾å¤‡
                const device = {
                    deviceId: `device-${ip.replace(/\./g, '-')}`,
                    deviceName: `è®¾å¤‡ (${ip})`,
                    ip: ip,
                    platform: 'Unknown',
                    lastSeen: Date.now()
                };
                
                showSearchStatus(`å·²æ‰¾åˆ°è®¾å¤‡: ${ip}`, 'success');
                log(`æ‰¾åˆ°è®¾å¤‡: ${device.deviceName}`, 'success');
                
                // æ·»åŠ åˆ°è®¾å¤‡åˆ—è¡¨
                addDeviceToList(device);
            } catch (error) {
                showSearchStatus(`æœªæ‰¾åˆ°è®¾å¤‡: ${ip}`, 'error');
                log(`æœªæ‰¾åˆ°è®¾å¤‡: ${ip}`, 'error');
            }
        }
        
        // æµ‹è¯•è®¾å¤‡è¿æ¥
        async function testDeviceConnection(ip) {
            return new Promise((resolve, reject) => {
                // åˆ›å»ºWebSocketè¿æ¥æµ‹è¯•
                const testWs = new WebSocket(`ws://${ip}:8928`);
                const timeout = setTimeout(() => {
                    testWs.close();
                    reject(new Error('è¿æ¥è¶…æ—¶'));
                }, 2000);
                
                testWs.onopen = function() {
                    clearTimeout(timeout);
                    testWs.close();
                    resolve();
                };
                
                testWs.onclose = function() {
                    clearTimeout(timeout);
                    // å³ä½¿è¿æ¥ç«‹å³å…³é—­ï¼Œä¹Ÿè®¤ä¸ºIPæ˜¯å¯è¾¾çš„
                    resolve();
                };
                
                testWs.onerror = function() {
                    clearTimeout(timeout);
                    testWs.close();
                    reject(new Error('æ— æ³•è¿æ¥'));
                };
            });
        }
        
        // éªŒè¯IPåœ°å€æ ¼å¼
        function validateIP(ip) {
            const ipRegex = /^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;
            if (!ipRegex.test(ip)) {
                return false;
            }
            
            // æ£€æŸ¥æ¯ä¸ªæ•°å­—æ˜¯å¦åœ¨0-255èŒƒå›´å†…
            const parts = ip.split('.');
            return parts.every(part => parseInt(part) >= 0 && parseInt(part) <= 255);
        }
        
        // è¿æ¥åˆ°ç‰¹å®šè®¾å¤‡
        function connectToDevice(deviceId) {
            const device = discoveredDevices[deviceId];
            if (!device || !device.ip) {
                log('è®¾å¤‡ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è¿æ¥', 'error');
                return;
            }
            
            log(`å°è¯•è¿æ¥åˆ°è®¾å¤‡: ${device.deviceName} (${device.ip})`, 'info');
            elements.connectionStatus.className = 'connection-status status-info';
            elements.connectionStatus.textContent = `æ­£åœ¨è¿æ¥åˆ° ${device.deviceName}...`;
            
            // å®é™…è¿æ¥é€»è¾‘
            const wsUrl = `ws://${device.ip}:8928`;
            ws = new WebSocket(wsUrl);
            
            // è¿æ¥è¶…æ—¶å¤„ç†
            const connectTimeout = setTimeout(() => {
                if (ws.readyState === WebSocket.CONNECTING) {
                    ws.close();
                    log(`è¿æ¥åˆ°è®¾å¤‡è¶…æ—¶: ${device.ip}`, 'error');
                    elements.connectionStatus.className = 'connection-status status-error';
                    elements.connectionStatus.textContent = 'è¿æ¥è¶…æ—¶';
                }
            }, 5000);
            
            ws.onopen = function(event) {
                clearTimeout(connectTimeout);
                log(`å·²è¿æ¥åˆ°è®¾å¤‡: ${device.deviceName}`, 'success');
                elements.connectionStatus.className = 'connection-status status-success';
                elements.connectionStatus.textContent = `å·²è¿æ¥åˆ°: ${device.deviceName}`;
                isConnected = true;
                device.connected = true;
                
                // å¯ç”¨æ–‡ä»¶ä¼ è¾“æŒ‰é’®
                elements.sendFileBtn.disabled = false;
                elements.receiveFileBtn.disabled = false;
                
                // å‘é€è®¾å¤‡ä¿¡æ¯
                ws.send(JSON.stringify({
                    type: 'device_info',
                    deviceInfo: {
                        platform: 'web_device_manager',
                        deviceName: 'è®¾å¤‡ç®¡ç†å™¨',
                        deviceId: 'web-device-manager-' + Date.now()
                    }
                }));
            };
            
            ws.onclose = function(event) {
                clearTimeout(connectTimeout);
                log(`ä¸è®¾å¤‡æ–­å¼€è¿æ¥: ${device.deviceName}`, 'info');
                elements.connectionStatus.className = 'connection-status status-info';
                elements.connectionStatus.textContent = 'å·²æ–­å¼€è¿æ¥';
                isConnected = false;
                device.connected = false;
                
                // ç¦ç”¨æ–‡ä»¶ä¼ è¾“æŒ‰é’®
                elements.sendFileBtn.disabled = true;
                elements.receiveFileBtn.disabled = true;
            };
        }
        
        // æ˜¾ç¤ºæœç´¢çŠ¶æ€
        function showSearchStatus(message, type = 'info') {
            elements.searchStatus.innerHTML = `<div class="connection-status status-${type}">${message}</div>`;
        }
        
        // æ·»åŠ è®¾å¤‡åˆ°åˆ—è¡¨
        function addDeviceToList(device) {
            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²å­˜åœ¨
            if (discoveredDevices[device.deviceId]) {
                // æ›´æ–°ç°æœ‰è®¾å¤‡ä¿¡æ¯
                updateDeviceInList(device);
                return;
            }
            
            // æ·»åŠ æ–°è®¾å¤‡
            discoveredDevices[device.deviceId] = device;
            
            const deviceCard = document.createElement('div');
            deviceCard.className = `device-card ${device.ip ? 'connected' : 'disconnected'}`;
            deviceCard.id = `device-${device.deviceId}`;
            
            deviceCard.innerHTML = `
                <div class="device-header">
                    <div class="device-name">${device.deviceName || 'æœªçŸ¥è®¾å¤‡'}</div>
                    <div class="device-status ${device.ip ? 'status-connected' : 'status-disconnected'}">
                        ${device.ip ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                    </div>
                </div>
                <div class="device-details">
                    <div>IP: ${device.ip || '-'}</div>
                    <div>å¹³å°: ${device.platform || 'æœªçŸ¥'}</div>
                    <div>æœ€åæ´»åŠ¨: ${device.lastSeen ? new Date(device.lastSeen).toLocaleString() : 'æœªçŸ¥'}</div>
                </div>
                <div class="device-actions">
                    <button class="btn-primary" onclick="connectToDevice('${device.deviceId}')">è¿æ¥</button>
                    <button class="btn-danger" onclick="removeDevice('${device.deviceId}')">ç§»é™¤</button>
                </div>
            `;
            
            // æ›¿æ¢é»˜è®¤çš„"æ— è®¾å¤‡"å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const noDeviceCard = elements.devicesContainer.querySelector('.device-card:only-child');
            if (noDeviceCard && noDeviceCard.querySelector('.device-name').textContent === 'æ— è®¾å¤‡') {
                elements.devicesContainer.innerHTML = '';
            }
            
            elements.devicesContainer.appendChild(deviceCard);
        }
        
        // æ›´æ–°è®¾å¤‡åˆ—è¡¨ä¸­çš„è®¾å¤‡
        function updateDeviceInList(device) {
            const deviceElement = document.getElementById(`device-${device.deviceId}`);
            if (deviceElement) {
                // æ›´æ–°è®¾å¤‡ä¿¡æ¯
                deviceElement.querySelector('.device-name').textContent = device.deviceName || 'æœªçŸ¥è®¾å¤‡';
                deviceElement.querySelector('.device-status').className = `device-status ${device.ip ? 'status-connected' : 'status-disconnected'}`;
                deviceElement.querySelector('.device-status').textContent = device.ip ? 'åœ¨çº¿' : 'ç¦»çº¿';
                deviceElement.querySelector('.device-details').innerHTML = `
                    <div>IP: ${device.ip || '-'}</div>
                    <div>å¹³å°: ${device.platform || 'æœªçŸ¥'}</div>
                    <div>æœ€åæ´»åŠ¨: ${device.lastSeen ? new Date(device.lastSeen).toLocaleString() : 'æœªçŸ¥'}</div>
                `;
                
                // æ›´æ–°çŠ¶æ€æ ·å¼
                deviceElement.className = `device-card ${device.ip ? 'connected' : 'disconnected'}`;
            }
        }
        
        // è¿æ¥åˆ°ç‰¹å®šè®¾å¤‡
        function connectToDevice(deviceId) {
            const device = discoveredDevices[deviceId];
            if (!device || !device.ip) {
                log('è®¾å¤‡ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è¿æ¥', 'error');
                return;
            }
            
            log(`å°è¯•è¿æ¥åˆ°è®¾å¤‡: ${device.deviceName} (${device.ip})`, 'info');
            elements.connectionStatus.className = 'connection-status status-info';
            elements.connectionStatus.textContent = `æ­£åœ¨è¿æ¥åˆ° ${device.deviceName}...`;
            
            // å®é™…è¿æ¥é€»è¾‘
            const wsUrl = `ws://${device.ip}:8928`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                log(`å·²è¿æ¥åˆ°è®¾å¤‡: ${device.deviceName}`, 'success');
                elements.connectionStatus.className = 'connection-status status-success';
                elements.connectionStatus.textContent = `å·²è¿æ¥åˆ°: ${device.deviceName}`;
                isConnected = true;
                device.connected = true;
                
                // å¯ç”¨æ–‡ä»¶ä¼ è¾“æŒ‰é’®
                elements.sendFileBtn.disabled = false;
                elements.receiveFileBtn.disabled = false;
                
                // å‘é€è®¾å¤‡ä¿¡æ¯
                ws.send(JSON.stringify({
                    type: 'device_info',
                    deviceInfo: {
                        platform: 'web_device_manager',
                        deviceName: 'è®¾å¤‡ç®¡ç†å™¨',
                        deviceId: 'web-device-manager-' + Date.now()
                    }
                }));
            };
            
            ws.onclose = function(event) {
                log(`ä¸è®¾å¤‡æ–­å¼€è¿æ¥: ${device.deviceName}`, 'info');
                elements.connectionStatus.className = 'connection-status status-info';
                elements.connectionStatus.textContent = 'å·²æ–­å¼€è¿æ¥';
                isConnected = false;
                device.connected = false;
                
                // ç¦ç”¨æ–‡ä»¶ä¼ è¾“æŒ‰é’®
                elements.sendFileBtn.disabled = true;
                elements.receiveFileBtn.disabled = true;
            };
        }
        
        // æ–‡ä»¶ä¼ è¾“ç›¸å…³
        let selectedFile = null;
        let activeTransfer = null;
        let transferHistory = [];
        const CHUNK_SIZE = 64 * 1024; // 64KB chunks
        
        // ç»Ÿä¸€é”™è¯¯å¤„ç†å¸¸é‡
        const ERROR_TYPES = {
            CONNECTION: { code: 1001, title: 'è¿æ¥é”™è¯¯' },
            NETWORK: { code: 1002, title: 'ç½‘ç»œé”™è¯¯' },
            FILE_TRANSFER: { code: 1003, title: 'æ–‡ä»¶ä¼ è¾“é”™è¯¯' },
            DEVICE: { code: 1004, title: 'è®¾å¤‡é”™è¯¯' },
            INVALID_INPUT: { code: 1005, title: 'è¾“å…¥é”™è¯¯' },
            UNKNOWN: { code: 9999, title: 'æœªçŸ¥é”™è¯¯' }
        };

        // æ·»åŠ é”™è¯¯å¤„ç†å‡½æ•°
        function handleError(errorType, message, details = null) {
            const errorInfo = ERROR_TYPES[errorType] || ERROR_TYPES.UNKNOWN;
            
            // è®°å½•åˆ°æ—¥å¿—
            log(`[${errorInfo.code}] ${errorInfo.title}: ${message}`, 'error');
            
            // æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
            showErrorModal(errorInfo.title, message, details);
            
            // å¦‚æœæ˜¯è¿æ¥é”™è¯¯ï¼Œå°è¯•é‡è¿
            if (errorType === 'CONNECTION' && currentConnectionInfo && reconnectAttempts < maxReconnectAttempts) {
                scheduleReconnect();
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¨¡æ€æ¡†
        function showErrorModal(title, message, details = null) {
            if (elements.errorModal) {
                elements.errorTitle.textContent = title;
                elements.errorMessage.textContent = message;
                
                if (details) {
                    elements.errorDetails.textContent = `è¯¦ç»†ä¿¡æ¯: ${details}`;
                    elements.errorDetails.style.display = 'block';
                } else {
                    elements.errorDetails.style.display = 'none';
                }
                
                elements.errorModal.style.display = 'flex';
            } else {
                // é™çº§æ˜¾ç¤ºalert
                alert(`${title}: ${message}\n${details || ''}`);
            }
        }

        // å…³é—­é”™è¯¯æ¨¡æ€æ¡†
        function closeErrorModal() {
            if (elements.errorModal) {
                elements.errorModal.style.display = 'none';
            }
        }

        // è°ƒåº¦é‡è¿
        function scheduleReconnect() {
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
            }
            
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 30000); // æŒ‡æ•°é€€é¿ï¼Œæœ€å¤§30ç§’
            
            log(`å°†åœ¨ ${delay/1000} ç§’åå°è¯•ç¬¬ ${reconnectAttempts}/${maxReconnectAttempts} æ¬¡é‡è¿`, 'info');
            
            reconnectTimeout = setTimeout(() => {
                if (currentConnectionInfo) {
                    log(`å°è¯•é‡è¿åˆ°è®¾å¤‡: ${currentConnectionInfo.deviceName}`, 'info');
                    connectToDevice(currentConnectionInfo.deviceId);
                }
            }, delay);
        }

        // é‡ç½®é‡è¿çŠ¶æ€
        function resetReconnectState() {
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            reconnectAttempts = 0;
        }

        // è¿æ¥åˆ°ç‰¹å®šè®¾å¤‡
        function connectToDevice(deviceId) {
            const device = discoveredDevices[deviceId];
            if (!device || !device.ip) {
                log('è®¾å¤‡ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è¿æ¥');
                return;
            }
            
            // ä¿å­˜è¿æ¥ä¿¡æ¯ç”¨äºé‡è¿
            currentConnectionInfo = device;
            
            log(`å°è¯•è¿æ¥åˆ°è®¾å¤‡: ${device.deviceName} (${device.ip})`, 'info');
            elements.connectionStatus.className = 'connection-status status-info';
            elements.connectionStatus.textContent = `æ­£åœ¨è¿æ¥åˆ° ${device.deviceName}...`;
            
            // å…ˆæ–­å¼€ä¹‹å‰çš„è¿æ¥
            if (ws && ws.readyState !== WebSocket.CLOSED) {
                ws.close();
            }
            
            // å®é™…è¿æ¥é€»è¾‘
            try {
                const wsUrl = `ws://${device.ip}:8928`;
                ws = new WebSocket(wsUrl);
                
                // è¿æ¥è¶…æ—¶å¤„ç†
                const connectTimeout = setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        ws.close();
                        handleError('CONNECTION', `è¿æ¥åˆ°è®¾å¤‡è¶…æ—¶: ${device.ip}`);
                    }
                }, 8000);
                
                ws.onopen = function(event) {
                    clearTimeout(connectTimeout);
                    resetReconnectState();
                    log(`å·²è¿æ¥åˆ°è®¾å¤‡: ${device.deviceName}`, 'success');
                    elements.connectionStatus.className = 'connection-status status-success';
                    elements.connectionStatus.textContent = `å·²è¿æ¥åˆ°: ${device.deviceName}`;
                    isConnected = true;
                    device.connected = true;
                    
                    // å¯ç”¨æ–‡ä»¶ä¼ è¾“æŒ‰é’®
                    elements.sendFileBtn.disabled = false;
                    elements.receiveFileBtn.disabled = false;
                    
                    // å‘é€è®¾å¤‡ä¿¡æ¯
                    try {
                        ws.send(JSON.stringify({
                            type: 'device_info',
                            deviceInfo: {
                                platform: 'web_device_manager',
                                deviceName: 'è®¾å¤‡ç®¡ç†å™¨',
                                deviceId: 'web-device-manager-' + Date.now()
                            }
                        }));
                    } catch (e) {
                        handleError('CONNECTION', 'å‘é€è®¾å¤‡ä¿¡æ¯å¤±è´¥', e.message);
                    }
                };
                
                ws.onclose = function(event) {
                    clearTimeout(connectTimeout);
                    log(`ä¸è®¾å¤‡æ–­å¼€è¿æ¥: ${device.deviceName}`, 'info');
                    elements.connectionStatus.className = 'connection-status status-info';
                    elements.connectionStatus.textContent = 'å·²æ–­å¼€è¿æ¥';
                    isConnected = false;
                    device.connected = false;
                    
                    // ç¦ç”¨æ–‡ä»¶ä¼ è¾“æŒ‰é’®
                    elements.sendFileBtn.disabled = true;
                    elements.receiveFileBtn.disabled = true;
                    
                    // å¦‚æœä¸æ˜¯ç”¨æˆ·ä¸»åŠ¨æ–­å¼€ï¼Œå°è¯•é‡è¿
                    if (reconnectAttempts < maxReconnectAttempts) {
                        handleError('CONNECTION', 'è¿æ¥æ„å¤–æ–­å¼€ï¼Œå°†å°è¯•é‡è¿', `é”™è¯¯ä»£ç : ${event.code}`);
                    }
                };
            } catch (error) {
                handleError('CONNECTION', `åˆ›å»ºè¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        // WebSocketé”™è¯¯å¤„ç†
        function setupWebSocketErrorHandler() {
            if (ws) {
                ws.onerror = function(error) {
                    const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                    handleError('CONNECTION', `è¿æ¥åˆ°è®¾å¤‡æ—¶å‡ºé”™: ${errorMessage}`);
                    elements.connectionStatus.className = 'connection-status status-error';
                    elements.connectionStatus.textContent = 'è¿æ¥å¤±è´¥';
                    isConnected = false;
                };
                
                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        // æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯æ¶ˆæ¯
                        if (message.type === 'error') {
                            handleError('DEVICE', message.message || 'è®¾å¤‡é”™è¯¯', JSON.stringify(message.details || {}));
                            return;
                        }
                        handleMessage(message);
                    } catch (e) {
                        handleError('CONNECTION', `æ¶ˆæ¯è§£æé”™è¯¯: ${e.message}`);
                    }
                };
            }
        }

        // å‘é€æ–‡ä»¶
        async function sendFile() {
            if (!selectedFile || !isConnected) {
                handleError('FILE_TRANSFER', 'æ— æ³•å‘é€æ–‡ä»¶ï¼šæœªé€‰æ‹©æ–‡ä»¶æˆ–æœªè¿æ¥è®¾å¤‡');
                return;
            }
            
            log(`å¼€å§‹å‘é€æ–‡ä»¶ï¼š${selectedFile.name}`, 'info');
            
            // è·å–å½“å‰è¿æ¥çš„è®¾å¤‡
            const connectedDevice = Object.values(discoveredDevices).find(device => device.connected);
            if (!connectedDevice) {
                handleError('DEVICE', 'æœªæ‰¾åˆ°è¿æ¥çš„è®¾å¤‡');
                return;
            }
            
            // é‡ç½®è¿›åº¦æ¡
            updateProgressBar(0);
            
            try {
                // åˆ›å»ºä¼ è¾“è®°å½•
                const transferId = generateTransferId();
                activeTransfer = {
                    id: transferId,
                    type: 'send',
                    fileName: selectedFile.name,
                    fileSize: selectedFile.size,
                    deviceId: connectedDevice.deviceId,
                    deviceName: connectedDevice.deviceName,
                    status: 'transferring',
                    progress: 0,
                    startTime: Date.now()
                };
                
                // è¯»å–æ–‡ä»¶å¹¶åˆ†å—å‘é€
                await sendFileInChunks(selectedFile, transferId, connectedDevice.deviceId);
                
                activeTransfer.status = 'completed';
                activeTransfer.endTime = Date.now();
                activeTransfer.duration = activeTransfer.endTime - activeTransfer.startTime;
                
                log(`æ–‡ä»¶å‘é€å®Œæˆï¼š${selectedFile.name}`, 'success');
                addToTransferHistory(activeTransfer);
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showNotification(`æ–‡ä»¶å‘é€æˆåŠŸ: ${selectedFile.name}`, 'success');
            } catch (error) {
                activeTransfer.status = 'error';
                activeTransfer.error = error.message;
                handleError('FILE_TRANSFER', `æ–‡ä»¶å‘é€å¤±è´¥ï¼š${error.message}`);
                addToTransferHistory(activeTransfer);
            } finally {
                activeTransfer = null;
            }
        }

        // åˆ†å—å‘é€æ–‡ä»¶
        async function sendFileInChunks(file, transferId, deviceId) {
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                let currentChunk = 0;
                let chunkSendAttempts = 0;
                const maxChunkRetries = 3;
                
                function readNextChunk() {
                    const start = currentChunk * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, file.size);
                    const chunk = file.slice(start, end);
                    
                    reader.onload = function(event) {
                        if (event.target.error) {
                            handleError('FILE_TRANSFER', 'æ–‡ä»¶è¯»å–é”™è¯¯');
                            reject(new Error('æ–‡ä»¶è¯»å–é”™è¯¯'));
                            return;
                        }
                        
                        try {
                            // å‘é€æ–‡ä»¶å—
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                ws.send(JSON.stringify({
                                    type: 'file_chunk',
                                    transferId: transferId,
                                    fileName: file.name,
                                    fileSize: file.size,
                                    chunkIndex: currentChunk,
                                    totalChunks: totalChunks,
                                    data: event.target.result
                                }));
                                
                                // æ›´æ–°è¿›åº¦
                                currentChunk++;
                                const progress = Math.floor((currentChunk / totalChunks) * 100);
                                updateProgressBar(progress);
                                
                                // é‡ç½®é‡è¯•è®¡æ•°
                                chunkSendAttempts = 0;
                                
                                if (currentChunk < totalChunks) {
                                    readNextChunk();
                                } else {
                                    // å‘é€å®Œæˆæ¶ˆæ¯
                                    ws.send(JSON.stringify({
                                        type: 'file_transfer_complete',
                                        transferId: transferId,
                                        fileName: file.name,
                                        fileSize: file.size,
                                        deviceId: deviceId
                                    }));
                                    resolve();
                                }
                            } else {
                                // è¿æ¥å·²å…³é—­ï¼Œå°è¯•é‡å‘
                                if (chunkSendAttempts < maxChunkRetries) {
                                    chunkSendAttempts++;
                                    log(`å—å‘é€å¤±è´¥ï¼Œå°è¯•é‡å‘ (${chunkSendAttempts}/${maxChunkRetries})`, 'warning');
                                    setTimeout(readNextChunk, 1000 * chunkSendAttempts);
                                } else {
                                    reject(new Error('WebSocketè¿æ¥å·²å…³é—­ä¸”é‡å‘å¤±è´¥'));
                                }
                            }
                        } catch (e) {
                            handleError('FILE_TRANSFER', `å‘é€æ–‡ä»¶å—æ—¶å‡ºé”™: ${e.message}`);
                            reject(e);
                        }
                    };
                    
                    reader.onerror = function() {
                        handleError('FILE_TRANSFER', 'æ–‡ä»¶è¯»å–é”™è¯¯');
                        reject(new Error('æ–‡ä»¶è¯»å–é”™è¯¯'));
                    };
                    
                    reader.readAsDataURL(chunk);
                }
                
                // å¼€å§‹è¯»å–ç¬¬ä¸€ä¸ªå—
                readNextChunk();
            });
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // ç®€å•å®ç°ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥ä½¿ç”¨æ›´å¥½çš„é€šçŸ¥åº“
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // è‡ªåŠ¨å…³é—­
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†å™¨
        function setupGlobalErrorHandlers() {
            // ç›‘å¬æœªæ•è·çš„å¼‚å¸¸
            window.addEventListener('error', function(event) {
                handleError('UNKNOWN', `å‘ç”Ÿæœªæ•è·å¼‚å¸¸: ${event.message}`, `${event.filename}:${event.lineno}`);
            });
            
            // ç›‘å¬Promiseæ‹’ç»
            window.addEventListener('unhandledrejection', function(event) {
                handleError('UNKNOWN', `Promiseæ‹’ç»æœªå¤„ç†: ${event.reason?.message || 'æœªçŸ¥åŸå› '}`);
            });
        }

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            // åˆå§‹åŒ–DOMå¼•ç”¨
            // ... existing initialization code ...
            
            // è®¾ç½®é”™è¯¯å¤„ç†
            setupGlobalErrorHandlers();
            setupWebSocketErrorHandler();
            
            // å…³é—­é”™è¯¯æ¨¡æ€æ¡†äº‹ä»¶
            if (elements.closeErrorBtn) {
                elements.closeErrorBtn.addEventListener('click', closeErrorModal);
            }
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            if (elements.errorModal) {
                elements.errorModal.addEventListener('click', function(event) {
                    if (event.target === elements.errorModal) {
                        closeErrorModal();
                    }
                });
            }
            
            // åˆå§‹åŒ–æ–‡ä»¶ä¼ è¾“
            initFileTransfer();
        }

        // è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
        init();

        // åˆå§‹åŒ–æ–‡ä»¶ä¼ è¾“åŠŸèƒ½
        function initFileTransfer() {
            // é€‰æ‹©æ–‡ä»¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            elements.selectFileBtn.addEventListener('click', function() {
                elements.fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
            elements.fileInput.addEventListener('change', function(event) {
                if (event.target.files && event.target.files[0]) {
                    selectedFile = event.target.files[0];
                    elements.selectedFileInfo.textContent = `å·²é€‰æ‹©: ${selectedFile.name} (${formatFileSize(selectedFile.size)})`;
                }
            });
            
            // å‘é€æ–‡ä»¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            elements.sendFileBtn.addEventListener('click', sendFile);
            
            // æ¥æ”¶æ–‡ä»¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            elements.receiveFileBtn.addEventListener('click', function() {
                showNotification('æ¥æ”¶æ–‡ä»¶åŠŸèƒ½å°šæœªå®ç°', 'info');
            });
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ç”Ÿæˆä¼ è¾“ID
        function generateTransferId() {
            return 'transfer-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        
        // æ·»åŠ åˆ°ä¼ è¾“å†å²
        function addToTransferHistory(transfer) {
            transferHistory.unshift(transfer);
            updateTransferHistoryUI();
        }
        
        // æ›´æ–°ä¼ è¾“å†å²UI
        function updateTransferHistoryUI() {
            const historyItems = document.getElementById('history-items');
            historyItems.innerHTML = '';
            
            transferHistory.slice(0, 10).forEach(transfer => {
                const item = document.createElement('div');
                item.className = `history-item history-${transfer.status}`;
                
                const statusIcon = transfer.status === 'completed' ? 'âœ“' : 
                                   transfer.status === 'error' ? 'âœ—' : 'âŸ³';
                
                item.innerHTML = `
                    <div class="history-status">${statusIcon}</div>
                    <div class="history-content">
                        <div class="history-filename">${transfer.fileName}</div>
                        <div class="history-info">
                            ${transfer.type === 'send' ? 'å‘é€åˆ°' : 'æ¥æ”¶è‡ª'} ${transfer.deviceName}
                        </div>
                        <div class="history-details">
                            ${formatFileSize(transfer.fileSize)} â€¢ 
                            ${new Date(transfer.startTime).toLocaleString()}
                        </div>
                    </div>
                `;
                
                historyItems.appendChild(item);
            });
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar(percent) {
            elements.transferProgressFill.style.width = `${percent}%`;
            elements.transferProgressInfo.textContent = `${percent}%`;
        }
        
        // å˜é‡åˆå§‹åŒ–
        let deviceRefreshInterval = null;
        let isScanning = false;
        let reconnectTimeout = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let currentConnectionInfo = null;
    </script>
</body>
</html>
