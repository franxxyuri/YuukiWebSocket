<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç®¡ç†å™¨ - Windows-Android Connect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-top: 70px; /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        }
        
        .modern-navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 70px;
        }
        
        .nav-logo {
            display: flex;
            align-items: center;
        }
        
        .nav-logo a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: white;
            font-weight: 600;
            font-size: 1.3rem;
        }
        
        .nav-logo-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.85);
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .nav-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.25);
        }
        
        .nav-icon {
            margin-right: 8px;
            font-size: 1.1rem;
        }
        
        .nav-text {
            font-size: 0.95rem;
        }
        
        .nav-toggle {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 5px;
        }
        
        .bar {
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 3px 0;
            transition: 0.3s;
            border-radius: 2px;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        @media screen and (max-width: 768px) {
            .nav-menu {
                position: fixed;
                left: -100%;
                top: 70px;
                flex-direction: column;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                width: 100%;
                text-align: center;
                transition: 0.3s;
                box-shadow: 0 10px 27px rgba(0, 0, 0, 0.05);
                padding: 20px 0;
            }
            
            .nav-menu.active {
                left: 0;
            }
            
            .nav-link {
                padding: 15px;
                margin: 5px 20px;
                display: flex;
                justify-content: center;
            }
            
            .nav-toggle {
                display: flex;
            }
            
            .nav-toggle.active .bar:nth-child(2) {
                opacity: 0;
            }
            
            .nav-toggle.active .bar:nth-child(1) {
                transform: translateY(8px) rotate(45deg);
            }
            
            .nav-toggle.active .bar:nth-child(3) {
                transform: translateY(-8px) rotate(-45deg);
            }
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .local-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        input, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input {
            flex: 1;
            min-width: 250px;
        }
        
        button {
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1976D2;
        }
        
        .btn-success {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #388E3C;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #D32F2F;
        }
        
        .btn-warning {
            background-color: #FF9800;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #F57C00;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .device-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .device-card.connected {
            border-left: 5px solid #4CAF50;
        }
        
        .device-card.disconnected {
            border-left: 5px solid #f44336;
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .device-name {
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .device-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-connected {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-disconnected {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .device-details {
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }
        
        .device-actions {
            margin-top: 15px;
            display: flex;
            gap: 5px;
        }
        
        .device-actions button {
            flex: 1;
            padding: 6px;
            font-size: 12px;
        }
        
        .connection-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .log-container {
            margin-top: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .log-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .log-area {
            height: 150px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 3px;
        }
        
        .log-time {
            color: #999;
            margin-right: 5px;
        }
        
        .log-info { color: #2196F3; }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-warning { color: #FF9800; }
    </style>
</head>
<body>
    <!-- ç°ä»£åŒ–å¯¼èˆªæ  -->
    <nav class="modern-navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="/frontend/index.html">
                    <span class="nav-logo-icon">ğŸ”—</span>
                    <span class="nav-logo-text">Windows-Android Connect</span>
                </a>
            </div>
            
            <div class="nav-menu" id="nav-menu">
                <a href="/frontend/index.html" class="nav-link" data-page="home">
                    <span class="nav-icon">ğŸ </span>
                    <span class="nav-text">é¦–é¡µ</span>
                </a>
                <a href="/frontend/pages/app-index.html" class="nav-link" data-page="dashboard">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span class="nav-text">ä»ªè¡¨æ¿</span>
                </a>
                <a href="/frontend/pages/device-manager.html" class="nav-link active" data-page="devices">
                    <span class="nav-icon">ğŸ“±</span>
                    <span class="nav-text">è®¾å¤‡ç®¡ç†</span>
                </a>
                <a href="/frontend/pages/screen-stream.html" class="nav-link" data-page="screen">
                    <span class="nav-icon">ğŸ“º</span>
                    <span class="nav-text">å±å¹•æŠ•å±</span>
                </a>
                <a href="/frontend/pages/react-index.html" class="nav-link" data-page="react">
                    <span class="nav-icon">âš›ï¸</span>
                    <span class="nav-text">Reactåº”ç”¨</span>
                </a>
            </div>
            
            <div class="nav-toggle" id="nav-toggle">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <header>
            <h1>è®¾å¤‡ç®¡ç†å™¨</h1>
            <p>ç®¡ç†Windows-Android Connectç½‘ç»œä¸­çš„è®¾å¤‡</p>
        </header>
        
        <div class="local-info">
            <h3>æœ¬æœºä¿¡æ¯</h3>
            <div id="local-info-content">æ­£åœ¨è·å–æœ¬æœºä¿¡æ¯...</div>
        </div>
        
        <div class="search-section">
            <h2>è®¾å¤‡å‘ç°ä¸è¿æ¥</h2>
            <div class="connection-status" id="connection-status">å‡†å¤‡å°±ç»ª</div>
            
            <div class="search-controls">
                <input type="text" id="ip-input" placeholder="è¾“å…¥è®¾å¤‡IPåœ°å€ (ä¾‹å¦‚: 192.168.1.100)">
                <button class="btn-primary" id="search-ip-btn">æœç´¢IP</button>
                <button class="btn-success" id="scan-network-btn">æ‰«æå±€åŸŸç½‘</button>
                <button class="btn-warning" id="refresh-devices-btn">åˆ·æ–°è®¾å¤‡</button>
            </div>
            
            <div id="search-status"></div>
        </div>
        
        <h2>å·²å‘ç°çš„è®¾å¤‡</h2>
        <div class="devices-grid" id="devices-container">
            <div class="device-card disconnected">
                <div class="device-header">
                    <div class="device-name">æ— è®¾å¤‡</div>
                    <div class="device-status status-disconnected">ç¦»çº¿</div>
                </div>
                <div class="device-details">
                    <div>IP: -</div>
                    <div>å¹³å°: -</div>
                    <div>æœ€åæ´»åŠ¨: -</div>
                </div>
                <div class="device-actions">
                    <button class="btn-primary" disabled>è¿æ¥</button>
                    <button class="btn-danger" disabled>ç§»é™¤</button>
                </div>
            </div>
        </div>
        
        <div class="log-container">
            <div class="log-header">æ“ä½œæ—¥å¿—</div>
            <div class="log-area" id="log-area"></div>
        </div>
    </div>

    <script>
        // DOMå…ƒç´ 
        const elements = {
            localInfoContent: document.getElementById('local-info-content'),
            connectionStatus: document.getElementById('connection-status'),
            ipInput: document.getElementById('ip-input'),
            searchIpBtn: document.getElementById('search-ip-btn'),
            scanNetworkBtn: document.getElementById('scan-network-btn'),
            refreshDevicesBtn: document.getElementById('refresh-devices-btn'),
            searchStatus: document.getElementById('search-status'),
            devicesContainer: document.getElementById('devices-container'),
            logArea: document.getElementById('log-area')
        };
        
        // å½“å‰è¿æ¥çš„WebSocket
        let ws = null;
        let isConnected = false;
        
        // å·²å‘ç°çš„è®¾å¤‡åˆ—è¡¨
        let discoveredDevices = {};
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;
            elements.logArea.appendChild(logEntry);
            elements.logArea.scrollTop = elements.logArea.scrollHeight;
        }
        
        // è·å–æœ¬æœºä¿¡æ¯
        function getLocalInfo() {
            // æ¨¡æ‹Ÿè·å–æœ¬æœºIPä¿¡æ¯
            elements.localInfoContent.innerHTML = `
                <div>è®¾å¤‡åç§°: ${navigator.platform} (æµè§ˆå™¨)</div>
                <div>IPåœ°å€: <span id="local-ip">è·å–ä¸­...</span></div>
                <div>WebSocketç«¯å£: 8928</div>
                <div>æœåŠ¡çŠ¶æ€: <span style="color: #4CAF50; font-weight: bold;">è¿è¡Œä¸­</span></div>
            `;
            
            // å°è¯•è·å–æœ¬æœºIP
            getLocalIP();
        }
        
        // è·å–æœ¬æœºIPåœ°å€
        async function getLocalIP() {
            try {
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.createDataChannel('');
                pc.createOffer()
                    .then(offer => pc.setLocalDescription(offer))
                    .catch(() => {});
                
                pc.onicecandidate = (ice) => {
                    if (ice && ice.candidate && ice.candidate.candidate) {
                        const myIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate)[1];
                        
                        if (myIP && !myIP.startsWith('192.168.1') && !myIP.startsWith('10.') && !myIP.startsWith('172.')) {
                            // å…¬ç½‘IP
                        } else {
                            // å±€åŸŸç½‘IP
                            document.getElementById('local-ip').textContent = myIP || '192.168.124.18';
                        }
                    }
                };
                
                setTimeout(() => {
                    pc.close();
                    // å¦‚æœWebRTCæ–¹æ³•å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    if (document.getElementById('local-ip').textContent === 'è·å–ä¸­...') {
                        document.getElementById('local-ip').textContent = '192.168.124.18';
                    }
                }, 1000);
            } catch (error) {
                document.getElementById('local-ip').textContent = '192.168.124.18';
            }
        }
        
        // æœç´¢ç‰¹å®šIPçš„è®¾å¤‡
        async function searchDeviceByIP() {
            const ip = elements.ipInput.value.trim();
            if (!ip) {
                showSearchStatus('è¯·è¾“å…¥IPåœ°å€', 'error');
                return;
            }
            
            // éªŒè¯IPåœ°å€æ ¼å¼
            const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipPattern.test(ip)) {
                showSearchStatus('IPåœ°å€æ ¼å¼ä¸æ­£ç¡®', 'error');
                return;
            }
            
            showSearchStatus(`æ­£åœ¨æœç´¢è®¾å¤‡: ${ip}...`, 'info');
            log(`æœç´¢è®¾å¤‡: ${ip}`, 'info');
            
            try {
                // å°è¯•è¿æ¥åˆ°æŒ‡å®šIPçš„WebSocketæœåŠ¡
                const wsUrl = `ws://${ip}:8928`;
                const testWs = new WebSocket(wsUrl);
                
                // è®¾ç½®è¶…æ—¶
                const timeout = setTimeout(() => {
                    testWs.close();
                    showSearchStatus(`è®¾å¤‡ ${ip} æœªå“åº”`, 'error');
                    log(`è®¾å¤‡ ${ip} æœªå“åº”`, 'error');
                }, 3000);
                
                testWs.onopen = function() {
                    clearTimeout(timeout);
                    testWs.close();
                    showSearchStatus(`åœ¨ ${ip} å‘ç°è®¾å¤‡!`, 'success');
                    log(`åœ¨ ${ip} å‘ç°è®¾å¤‡!`, 'success');
                    
                    // æ·»åŠ è®¾å¤‡åˆ°åˆ—è¡¨
                    addDeviceToList({
                        deviceId: `temp_${ip}`,
                        deviceName: `æœªçŸ¥è®¾å¤‡ (${ip})`,
                        ip: ip,
                        platform: 'unknown',
                        lastSeen: Date.now()
                    });
                };
                
                testWs.onerror = function() {
                    clearTimeout(timeout);
                    testWs.close();
                    showSearchStatus(`æ— æ³•è¿æ¥åˆ° ${ip}`, 'error');
                    log(`æ— æ³•è¿æ¥åˆ° ${ip}`, 'error');
                };
                
            } catch (error) {
                showSearchStatus(`æœç´¢å¤±è´¥: ${error.message}`, 'error');
                log(`æœç´¢å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ‰«æå±€åŸŸç½‘ä¸­çš„è®¾å¤‡
        async function scanNetworkForDevices() {
            // è·å–æœ¬æœºIPå¹¶ç¡®å®šå­ç½‘
            const localIPText = document.getElementById('local-ip').textContent;
            if (!localIPText || localIPText === 'è·å–ä¸­...') {
                showSearchStatus('æ­£åœ¨è·å–æœ¬æœºIPï¼Œè¯·ç¨åå†è¯•', 'error');
                return;
            }
            
            const localIP = localIPText.match(/(\d+\.\d+\.\d+)\.(\d+)/);
            if (!localIP) {
                showSearchStatus('æ— æ³•ç¡®å®šå±€åŸŸç½‘å­ç½‘', 'error');
                return;
            }
            
            const subnet = localIP[1];
            showSearchStatus(`æ­£åœ¨æ‰«æå­ç½‘: ${subnet}.0/24...`, 'info');
            log(`å¼€å§‹æ‰«æå­ç½‘ ${subnet}.0/24`, 'info');
            
            // æ¨¡æ‹Ÿæ‰«æè¿‡ç¨‹ - åœ¨å®é™…åº”ç”¨ä¸­éœ€è¦åç«¯APIæ”¯æŒ
            setTimeout(() => {
                showSearchStatus(`å±€åŸŸç½‘æ‰«æå®Œæˆï¼Œå‘ç° 0 ä¸ªè®¾å¤‡`, 'info');
                log(`å±€åŸŸç½‘æ‰«æå®Œæˆ`, 'info');
            }, 2000);
        }
        
        // æ˜¾ç¤ºæœç´¢çŠ¶æ€
        function showSearchStatus(message, type = 'info') {
            elements.searchStatus.innerHTML = `<div class="connection-status status-${type}">${message}</div>`;
        }
        
        // æ·»åŠ è®¾å¤‡åˆ°åˆ—è¡¨
        function addDeviceToList(device) {
            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²å­˜åœ¨
            if (discoveredDevices[device.deviceId]) {
                // æ›´æ–°ç°æœ‰è®¾å¤‡ä¿¡æ¯
                updateDeviceInList(device);
                return;
            }
            
            // æ·»åŠ æ–°è®¾å¤‡
            discoveredDevices[device.deviceId] = device;
            
            const deviceCard = document.createElement('div');
            deviceCard.className = `device-card ${device.ip ? 'connected' : 'disconnected'}`;
            deviceCard.id = `device-${device.deviceId}`;
            
            deviceCard.innerHTML = `
                <div class="device-header">
                    <div class="device-name">${device.deviceName || 'æœªçŸ¥è®¾å¤‡'}</div>
                    <div class="device-status ${device.ip ? 'status-connected' : 'status-disconnected'}">
                        ${device.ip ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                    </div>
                </div>
                <div class="device-details">
                    <div>IP: ${device.ip || '-'}</div>
                    <div>å¹³å°: ${device.platform || 'æœªçŸ¥'}</div>
                    <div>æœ€åæ´»åŠ¨: ${device.lastSeen ? new Date(device.lastSeen).toLocaleString() : 'æœªçŸ¥'}</div>
                </div>
                <div class="device-actions">
                    <button class="btn-primary" onclick="connectToDevice('${device.deviceId}')">è¿æ¥</button>
                    <button class="btn-danger" onclick="removeDevice('${device.deviceId}')">ç§»é™¤</button>
                </div>
            `;
            
            // æ›¿æ¢é»˜è®¤çš„"æ— è®¾å¤‡"å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const noDeviceCard = elements.devicesContainer.querySelector('.device-card:only-child');
            if (noDeviceCard && noDeviceCard.querySelector('.device-name').textContent === 'æ— è®¾å¤‡') {
                elements.devicesContainer.innerHTML = '';
            }
            
            elements.devicesContainer.appendChild(deviceCard);
        }
        
        // æ›´æ–°è®¾å¤‡åˆ—è¡¨ä¸­çš„è®¾å¤‡
        function updateDeviceInList(device) {
            const deviceElement = document.getElementById(`device-${device.deviceId}`);
            if (deviceElement) {
                // æ›´æ–°è®¾å¤‡ä¿¡æ¯
                deviceElement.querySelector('.device-name').textContent = device.deviceName || 'æœªçŸ¥è®¾å¤‡';
                deviceElement.querySelector('.device-status').className = `device-status ${device.ip ? 'status-connected' : 'status-disconnected'}`;
                deviceElement.querySelector('.device-status').textContent = device.ip ? 'åœ¨çº¿' : 'ç¦»çº¿';
                deviceElement.querySelector('.device-details').innerHTML = `
                    <div>IP: ${device.ip || '-'}</div>
                    <div>å¹³å°: ${device.platform || 'æœªçŸ¥'}</div>
                    <div>æœ€åæ´»åŠ¨: ${device.lastSeen ? new Date(device.lastSeen).toLocaleString() : 'æœªçŸ¥'}</div>
                `;
                
                // æ›´æ–°çŠ¶æ€æ ·å¼
                deviceElement.className = `device-card ${device.ip ? 'connected' : 'disconnected'}`;
            }
        }
        
        // è¿æ¥åˆ°ç‰¹å®šè®¾å¤‡
        function connectToDevice(deviceId) {
            const device = discoveredDevices[deviceId];
            if (!device || !device.ip) {
                log('è®¾å¤‡ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•è¿æ¥', 'error');
                return;
            }
            
            log(`å°è¯•è¿æ¥åˆ°è®¾å¤‡: ${device.deviceName} (${device.ip})`, 'info');
            elements.connectionStatus.className = 'connection-status status-info';
            elements.connectionStatus.textContent = `æ­£åœ¨è¿æ¥åˆ° ${device.deviceName}...`;
            
            // å®é™…è¿æ¥é€»è¾‘
            const wsUrl = `ws://${device.ip}:8928`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                log(`å·²è¿æ¥åˆ°è®¾å¤‡: ${device.deviceName}`, 'success');
                elements.connectionStatus.className = 'connection-status status-success';
                elements.connectionStatus.textContent = `å·²è¿æ¥åˆ°: ${device.deviceName}`;
                isConnected = true;
                
                // å‘é€è®¾å¤‡ä¿¡æ¯
                ws.send(JSON.stringify({
                    type: 'device_info',
                    deviceInfo: {
                        platform: 'web_device_manager',
                        deviceName: 'è®¾å¤‡ç®¡ç†å™¨',
                        deviceId: 'web-device-manager-' + Date.now()
                    }
                }));
            };
            
            ws.onclose = function(event) {
                log(`ä¸è®¾å¤‡æ–­å¼€è¿æ¥: ${device.deviceName}`, 'info');
                elements.connectionStatus.className = 'connection-status status-info';
                elements.connectionStatus.textContent = 'å·²æ–­å¼€è¿æ¥';
                isConnected = false;
            };
            
            ws.onerror = function(error) {
                log(`è¿æ¥åˆ°è®¾å¤‡æ—¶å‡ºé”™: ${error.message}`, 'error');
                elements.connectionStatus.className = 'connection-status status-error';
                elements.connectionStatus.textContent = 'è¿æ¥å¤±è´¥';
                isConnected = false;
            };
            
            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (e) {
                    log(`æ¶ˆæ¯è§£æé”™è¯¯: ${e.message}`, 'error');
                }
            };
        }
        
        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleMessage(message) {
            switch (message.type) {
                case 'device_found':
                    log(`å‘ç°æ–°è®¾å¤‡: ${message.device.deviceName}`, 'success');
                    addDeviceToList(message.device);
                    break;
                case 'android_connected':
                    log(`Androidè®¾å¤‡å·²è¿æ¥: ${message.deviceInfo.deviceName}`, 'success');
                    break;
                case 'android_disconnected':
                    log('Androidè®¾å¤‡å·²æ–­å¼€è¿æ¥', 'info');
                    break;
                default:
                    log(`æ”¶åˆ°æ¶ˆæ¯: ${message.type}`, 'info');
                    break;
            }
        }
        
        // ç§»é™¤è®¾å¤‡
        function removeDevice(deviceId) {
            delete discoveredDevices[deviceId];
            const deviceElement = document.getElementById(`device-${deviceId}`);
            if (deviceElement) {
                deviceElement.remove();
                
                // å¦‚æœæ²¡æœ‰è®¾å¤‡äº†ï¼Œæ˜¾ç¤º"æ— è®¾å¤‡"å¡ç‰‡
                if (elements.devicesContainer.children.length === 0) {
                    const noDeviceCard = document.createElement('div');
                    noDeviceCard.className = 'device-card disconnected';
                    noDeviceCard.innerHTML = `
                        <div class="device-header">
                            <div class="device-name">æ— è®¾å¤‡</div>
                            <div class="device-status status-disconnected">ç¦»çº¿</div>
                        </div>
                        <div class="device-details">
                            <div>IP: -</div>
                            <div>å¹³å°: -</div>
                            <div>æœ€åæ´»åŠ¨: -</div>
                        </div>
                        <div class="device-actions">
                            <button class="btn-primary" disabled>è¿æ¥</button>
                            <button class="btn-danger" disabled>ç§»é™¤</button>
                        </div>
                    `;
                    elements.devicesContainer.appendChild(noDeviceCard);
                }
            }
            log(`å·²ç§»é™¤è®¾å¤‡: ${deviceId}`, 'info');
        }
        
        // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
        function refreshDevices() {
            log('åˆ·æ–°è®¾å¤‡åˆ—è¡¨', 'info');
            showSearchStatus('æ­£åœ¨åˆ·æ–°è®¾å¤‡åˆ—è¡¨...', 'info');
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šå‘æœåŠ¡å™¨è¯·æ±‚æœ€æ–°è®¾å¤‡åˆ—è¡¨
            setTimeout(() => {
                showSearchStatus('è®¾å¤‡åˆ—è¡¨å·²åˆ·æ–°', 'success');
            }, 1000);
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            elements.searchIpBtn.addEventListener('click', searchDeviceByIP);
            elements.scanNetworkBtn.addEventListener('click', scanNetworkForDevices);
            elements.refreshDevicesBtn.addEventListener('click', refreshDevices);
            
            // æŒ‰Enteré”®æœç´¢IP
            elements.ipInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchDeviceByIP();
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('è®¾å¤‡ç®¡ç†å™¨å·²åŠ è½½', 'info');
            getLocalInfo();
            setupEventListeners();
        });
        
        // ç°ä»£åŒ–å¯¼èˆªåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const navToggle = document.getElementById('nav-toggle');
            const navMenu = document.getElementById('nav-menu');
            
            // åˆ‡æ¢ç§»åŠ¨ç«¯èœå•
            navToggle.addEventListener('click', function() {
                navMenu.classList.toggle('active');
                navToggle.classList.toggle('active');
            });
            
            // å¤„ç†å¯¼èˆªé“¾æ¥ç‚¹å‡»
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    // åœ¨ç§»åŠ¨ç«¯ç‚¹å‡»å¯¼èˆªé¡¹åå…³é—­èœå•
                    if (window.innerWidth <= 768) {
                        navMenu.classList.remove('active');
                        navToggle.classList.remove('active');
                    }
                    
                    // ç§»é™¤å…¶ä»–æ´»åŠ¨çŠ¶æ€
                    navLinks.forEach(l => l.classList.remove('active'));
                    // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
                    this.classList.add('active');
                });
            });
            
            // æ ¹æ®å½“å‰é¡µé¢è®¾ç½®æ´»åŠ¨çŠ¶æ€
            function setActiveNavLink() {
                const currentPath = window.location.pathname;
                navLinks.forEach(link => {
                    if (link.getAttribute('href') === currentPath) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
            }
            
            setActiveNavLink();
        });
        
        // ä½¿å‡½æ•°å¯åœ¨å…¨å±€ä½œç”¨åŸŸè®¿é—®ï¼ˆä¾›æŒ‰é’®ä½¿ç”¨ï¼‰
        window.connectToDevice = connectToDevice;
        window.removeDevice = removeDevice;
    </script>
</body>
</html>