<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows-Android Connect - 客户端测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            min-width: 120px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .device-list {
            margin-top: 20px;
        }
        .device-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
            background-color: #f8f9fa;
        }
        .log-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        .log-info {
            color: #007bff;
        }
        .log-error {
            color: #dc3545;
        }
        .log-success {
            color: #28a745;
        }
        .log-warning {
            color: #ffc107;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Windows-Android Connect - 客户端测试页面</h1>
        
        <div id="connectionStatus" class="status disconnected">
            未连接到服务器
        </div>
        
        <div class="form-group">
            <label for="serverUrl">服务器地址:</label>
            <input type="text" id="serverUrl" value="ws://localhost:3000/ws" placeholder="输入服务器WebSocket地址">
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button id="connectBtn">连接服务器</button>
            <button id="disconnectBtn" disabled>断开连接</button>
        </div>
        
        <div id="deviceDiscovery">
            <h2>设备发现</h2>
            <div style="text-align: center; margin: 10px 0;">
                <button id="startDiscoveryBtn" disabled>开始设备发现</button>
                <button id="stopDiscoveryBtn" disabled>停止设备发现</button>
                <button id="refreshDevicesBtn" disabled>刷新设备列表</button>
            </div>
            <div id="deviceList" class="device-list">
                <p>暂无设备</p>
            </div>
        </div>
        
        <div id="fileTransfer">
            <h2>文件传输</h2>
            <div class="form-group">
                <label for="targetDeviceId">目标设备ID:</label>
                <input type="text" id="targetDeviceId" placeholder="输入目标设备ID">
            </div>
            <div style="text-align: center; margin: 10px 0;">
                <button id="sendFileBtn" disabled>发送文件</button>
            </div>
        </div>
        
        <div id="screenStreaming">
            <h2>屏幕投屏</h2>
            <div class="form-group">
                <label for="streamingDeviceId">设备ID:</label>
                <input type="text" id="streamingDeviceId" placeholder="输入设备ID">
            </div>
            <div style="text-align: center; margin: 10px 0;">
                <button id="startStreamingBtn" disabled>开始投屏</button>
                <button id="stopStreamingBtn" disabled>停止投屏</button>
            </div>
        </div>
        
        <div id="remoteControl">
            <h2>远程控制</h2>
            <div class="form-group">
                <label for="controlDeviceId">设备ID:</label>
                <input type="text" id="controlDeviceId" placeholder="输入设备ID">
            </div>
            <div style="text-align: center; margin: 10px 0;">
                <button id="enableControlBtn" disabled>启用远程控制</button>
            </div>
        </div>
        
        <div id="logPanel" class="log-panel">
            <h3>日志输出</h3>
            <div id="logEntries"></div>
        </div>
    </div>

    <script>
        let socket = null;
        let discoveredDevices = [];
        let logEntries = [];
        
        // DOM元素
        const connectionStatus = document.getElementById('connectionStatus');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startDiscoveryBtn = document.getElementById('startDiscoveryBtn');
        const stopDiscoveryBtn = document.getElementById('stopDiscoveryBtn');
        const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
        const sendFileBtn = document.getElementById('sendFileBtn');
        const startStreamingBtn = document.getElementById('startStreamingBtn');
        const stopStreamingBtn = document.getElementById('stopStreamingBtn');
        const enableControlBtn = document.getElementById('enableControlBtn');
        const deviceList = document.getElementById('deviceList');
        const logEntriesDiv = document.getElementById('logEntries');
        const serverUrlInput = document.getElementById('serverUrl');
        const targetDeviceIdInput = document.getElementById('targetDeviceId');
        const streamingDeviceIdInput = document.getElementById('streamingDeviceId');
        const controlDeviceIdInput = document.getElementById('controlDeviceId');
        
        // 日志函数
        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                level
            };
            logEntries.push(logEntry);
            
            const logElement = document.createElement('div');
            logElement.className = `log-entry log-${level}`;
            logElement.textContent = `[${timestamp}] ${message}`;
            logEntriesDiv.appendChild(logElement);
            
            // 滚动到底部
            logEntriesDiv.scrollTop = logEntriesDiv.scrollHeight;
            
            // 限制日志数量
            if (logEntries.length > 100) {
                logEntries.shift();
                logEntriesDiv.removeChild(logEntriesDiv.firstChild);
            }
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        // 更新连接状态显示
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.textContent = '已连接到服务器';
                connectionStatus.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                startDiscoveryBtn.disabled = false;
                stopDiscoveryBtn.disabled = false;
                refreshDevicesBtn.disabled = false;
                sendFileBtn.disabled = false;
                startStreamingBtn.disabled = false;
                stopStreamingBtn.disabled = false;
                enableControlBtn.disabled = false;
                log('成功连接到服务器', 'success');
            } else {
                connectionStatus.textContent = '未连接到服务器';
                connectionStatus.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                startDiscoveryBtn.disabled = true;
                stopDiscoveryBtn.disabled = true;
                refreshDevicesBtn.disabled = true;
                sendFileBtn.disabled = true;
                startStreamingBtn.disabled = true;
                stopStreamingBtn.disabled = true;
                enableControlBtn.disabled = true;
                log('已断开与服务器的连接', 'warning');
            }
        }
        
        // 连接服务器
        connectBtn.addEventListener('click', () => {
            const serverUrl = serverUrlInput.value;
            if (!serverUrl) {
                log('请输入服务器地址', 'error');
                return;
            }
            
            try {
                socket = new WebSocket(serverUrl);
                log(`正在连接到服务器: ${serverUrl}`, 'info');
                
                socket.onopen = function(event) {
                    log('WebSocket连接已建立', 'success');
                    updateConnectionStatus(true);
                    
                    // 发送设备信息（模拟Web客户端）
                    socket.send(JSON.stringify({
                        type: 'device_info',
                        deviceInfo: {
                            platform: 'web',
                            deviceName: 'Web Client Test',
                            deviceId: 'web-test-' + Date.now()
                        }
                    }));
                    log('已发送设备信息', 'info');
                };
                
                socket.onclose = function(event) {
                    log(`WebSocket连接已关闭: ${event.reason || '未知原因'}`, 'warning');
                    updateConnectionStatus(false);
                };
                
                socket.onerror = function(error) {
                    log(`WebSocket连接错误: ${error.message}`, 'error');
                    updateConnectionStatus(false);
                };
                
                socket.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        log(`收到服务器消息: ${message.type}`, 'info');
                        
                        // 根据消息类型处理
                        switch (message.type) {
                            case 'device_found':
                                log(`发现设备: ${JSON.stringify(message.device)}`, 'success');
                                addDeviceToList(message.device);
                                break;
                            case 'android_connected':
                                log(`Android设备已连接: ${JSON.stringify(message.deviceInfo)}`, 'success');
                                updateDeviceStatus(message.deviceInfo.deviceId, '已连接');
                                break;
                            case 'screen_frame':
                                log(`收到屏幕帧: ${message.timestamp}`, 'info');
                                break;
                            case 'file_transfer':
                                log(`文件传输消息: ${message.action}`, 'info');
                                break;
                            case 'clipboard':
                                log(`剪贴板消息: ${message.data.substring(0, 50)}...`, 'info');
                                break;
                            case 'notification':
                                log(`通知消息: ${message.title}`, 'info');
                                break;
                            case 'control_command_response':
                                log(`控制命令响应: ${JSON.stringify(message)}`, 'info');
                                break;
                            default:
                                log(`未知消息类型: ${message.type}`, 'warning');
                                break;
                        }
                    } catch (error) {
                        log(`处理消息时出错: ${error.message}`, 'error');
                    }
                };
            } catch (error) {
                log(`连接失败: ${error.message}`, 'error');
                updateConnectionStatus(false);
            }
        });
        
        // 断开连接
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.close();
                socket = null;
                updateConnectionStatus(false);
                deviceList.innerHTML = '<p>暂无设备</p>';
                discoveredDevices = [];
                log('已断开连接', 'info');
            }
        });
        
        // 开始设备发现
        startDiscoveryBtn.addEventListener('click', () => {
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'start_device_discovery'
                }));
                log('已发送开始设备发现命令', 'info');
                
                // 模拟获取设备列表
                socket.send(JSON.stringify({
                    type: 'get_discovered_devices'
                }));
                log('已发送获取设备列表命令', 'info');
            }
        });
        
        // 停止设备发现
        stopDiscoveryBtn.addEventListener('click', () => {
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'stop_device_discovery'
                }));
                log('已发送停止设备发现命令', 'info');
            }
        });
        
        // 刷新设备列表
        refreshDevicesBtn.addEventListener('click', () => {
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'get_discovered_devices'
                }));
                log('已发送刷新设备列表命令', 'info');
            }
        });
        
        // 发送文件
        sendFileBtn.addEventListener('click', () => {
            const targetDeviceId = targetDeviceIdInput.value;
            if (!targetDeviceId) {
                log('请输入目标设备ID', 'error');
                return;
            }
            
            if (socket) {
                // 模拟发送文件
                socket.send(JSON.stringify({
                    type: 'file_transfer',
                    action: 'send',
                    deviceId: targetDeviceId,
                    fileName: 'test.txt',
                    fileSize: 1024,
                    filePath: '/path/to/test.txt'
                }));
                log(`已发送文件传输命令: ${targetDeviceId}`, 'success');
            } else {
                log('未连接到服务器', 'error');
            }
        });
        
        // 开始投屏
        startStreamingBtn.addEventListener('click', () => {
            const deviceId = streamingDeviceIdInput.value;
            if (!deviceId) {
                log('请输入设备ID', 'error');
                return;
            }
            
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'control_command',
                    commandType: 'start_streaming',
                    deviceId: deviceId
                }));
                log(`已发送开始投屏命令: ${deviceId}`, 'success');
            } else {
                log('未连接到服务器', 'error');
            }
        });
        
        // 停止投屏
        stopStreamingBtn.addEventListener('click', () => {
            const deviceId = streamingDeviceIdInput.value;
            if (!deviceId) {
                log('请输入设备ID', 'error');
                return;
            }
            
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'control_command',
                    commandType: 'stop_streaming',
                    deviceId: deviceId
                }));
                log(`已发送停止投屏命令: ${deviceId}`, 'success');
            } else {
                log('未连接到服务器', 'error');
            }
        });
        
        // 启用远程控制
        enableControlBtn.addEventListener('click', () => {
            const deviceId = controlDeviceIdInput.value;
            if (!deviceId) {
                log('请输入设备ID', 'error');
                return;
            }
            
            if (socket) {
                socket.send(JSON.stringify({
                    type: 'control_command',
                    commandType: 'enable_control',
                    deviceId: deviceId
                }));
                log(`已发送启用远程控制命令: ${deviceId}`, 'success');
            } else {
                log('未连接到服务器', 'error');
            }
        });
        
        // 添加设备到列表
        function addDeviceToList(device) {
            // 检查设备是否已存在
            const existingDevice = discoveredDevices.find(d => d.deviceId === device.deviceId);
            if (!existingDevice) {
                discoveredDevices.push(device);
            }
            
            const deviceElement = document.createElement('div');
            deviceElement.className = 'device-item';
            deviceElement.innerHTML = `
                <strong>${device.deviceName || '未知设备'}</strong>
                <br>ID: ${device.deviceId}
                <br>平台: ${device.platform || '未知'}
                <br>型号: ${device.model || '未知'}
                <br>IP: ${device.ip || '未知'}
                <br>状态: <span id="status-${device.deviceId}">已发现</span>
            `;
            deviceList.appendChild(deviceElement);
        }
        
        // 更新设备状态
        function updateDeviceStatus(deviceId, status) {
            const statusElement = document.getElementById(`status-${deviceId}`);
            if (statusElement) {
                statusElement.textContent = status;
            }
        }
        
        // 初始化
        updateConnectionStatus(false);
    </script>
</body>
</html>