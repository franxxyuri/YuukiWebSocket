# Windows-Android Connect 安卓客户端通信协议

## 概述

本文档详细描述了Windows服务端与Android客户端之间的通信协议，包括连接建立、消息格式、功能接口等。

## 通信方式

- **协议**: WebSocket (ws://)
- **端口**: 8828 (由服务端配置决定)
- **消息格式**: JSON字符串
- **消息分隔符**: 换行符(\n) (对于TCP连接)

## 连接建立流程

### 1. Android客户端连接
1. 客户端使用WebSocket连接到 `ws://<Windows_IP>:8828`
2. 连接建立后，客户端发送设备信息消息
3. 服务端确认连接并分配客户端ID

### 2. 设备信息注册
客户端连接成功后，立即发送设备信息：
```json
{
  "type": "device_info",
  "deviceInfo": {
    "deviceId": "android-device-uuid",
    "deviceName": "设备型号",
    "platform": "android",
    "version": "1.0.0",
    "ip": "192.168.1.x",
    "capabilities": ["file_transfer", "screen_mirror", "remote_control", "notification", "clipboard_sync"]
  }
}
```

## 消息类型定义

### 1. 连接相关

#### 心跳消息 (Heartbeat)
- **客户端 → 服务端** 或 **服务端 → 客户端**
```json
{
  "type": "heartbeat",
  "timestamp": 1234567890
}
```

#### 连接建立确认
- **服务端 → 客户端**
```json
{
  "type": "connection_established",
  "clientId": "client-123456",
  "timestamp": 1234567890
}
```

### 2. 屏幕相关

#### 屏幕帧传输
- **客户端 → 服务端**
```json
{
  "type": "screen_frame",
  "frameData": "base64_encoded_image_data",
  "timestamp": 1234567890
}
```

#### 屏幕流请求
- **服务端 → 客户端**
```json
{
  "type": "control_command",
  "commandType": "start_streaming"
}
```

### 3. 文件传输

#### 文件传输消息
- **客户端 ↔ 服务端**
```json
{
  "type": "file_transfer",
  "action": "send|receive|progress|complete|error",
  "transferId": "transfer-uuid",
  "fileName": "example.txt",
  "fileSize": 102400,
  "progress": 50,
  "filePath": "/path/to/file"
}
```

### 4. 远程控制

#### 控制命令
- **服务端 → 客户端** (来自Web前端的控制指令)
```json
{
  "type": "control_command",
  "commandType": "tap|swipe|key|text|home|back|power|volume_up|volume_down",
  "x": 100,
  "y": 200,
  "dx": 150,
  "dy": 250,
  "keyCode": 4,
  "text": "Hello World"
}
```

### 5. 通知同步

#### 通知消息
- **客户端 → 服务端**
```json
{
  "type": "notification",
  "packageName": "com.example.app",
  "title": "通知标题",
  "text": "通知内容",
  "timestamp": 1234567890,
  "priority": "high|normal|low"
}
```

### 6. 剪贴板同步

#### 剪贴板消息
- **客户端 ↔ 服务端**
```json
{
  "type": "clipboard",
  "data": "剪贴板内容",
  "timestamp": 1234567890
}
```

## 服务端API接口

### 1. HTTP接口

#### 获取设备列表
- **GET** `/api/devices`
```json
[
  {
    "id": "client-123456",
    "type": "android|web",
    "ip": "192.168.1.x",
    "connected": true
  }
]
```

#### 获取服务器状态
- **GET** `/api/status`
```json
{
  "server": "running",
  "timestamp": 1234567890,
  "androidConnected": true,
  "totalClients": 2
}
```

### 2. WebSocket消息响应

#### 设备发现
- **服务端 → Web客户端**
```json
{
  "type": "device_found",
  "device": {
    "deviceId": "android-device-uuid",
    "deviceName": "设备名称",
    "platform": "android",
    "ip": "192.168.1.x",
    "lastSeen": 1234567890
  }
}
```

#### Android设备连接状态
- **服务端 → Web客户端**
```json
{
  "type": "android_connected",
  "deviceInfo": {
    "deviceId": "android-device-uuid",
    "deviceName": "设备名称",
    "platform": "android",
    "ip": "192.168.1.x"
  }
}
```

#### 屏幕帧广播
- **服务端 → Web客户端**
```json
{
  "type": "screen_frame",
  "frameData": "base64_encoded_image_data",
  "timestamp": 1234567890
}
```

## 通信流程示例

### 1. 屏幕镜像流程
1. Web前端发送开始镜像请求
2. 服务端转发请求到Android客户端
3. Android客户端开始屏幕捕获
4. Android客户端持续发送屏幕帧
5. 服务端广播屏幕帧到所有Web客户端

### 2. 文件传输流程
1. Web前端选择文件并发起传输
2. 服务端接收文件并转发给Android客户端
3. Android客户端接收文件并保存
4. Android客户端发送传输状态

### 3. 远程控制流程
1. Web前端发送控制指令（如点击、滑动）
2. 服务端接收指令并转发给Android客户端
3. Android客户端执行相应操作
4. Android客户端可发送执行结果

## 设备发现机制

### UDP广播
- **端口**: 8090
- **Android设备广播格式**:
```
ANDROID_DEVICE:<deviceId>:<deviceName>:<version>
```
- **Windows服务端广播格式**:
```
WINDOWS_DEVICE:<deviceId>:<deviceName>:<version>
```

## 错误处理

### 常见错误消息
```json
{
  "type": "error",
  "message": "错误描述",
  "code": "error_code",
  "timestamp": 1234567890
}
```

### 连接断开
- 当客户端断开连接时，服务端会清理相关资源
- 通知所有Web客户端连接断开

## 安全注意事项

1. 所有通信都在局域网内进行
2. 无身份验证机制，仅依赖局域网隔离
3. 建议在可信网络环境中使用
4. 传输的敏感信息（如屏幕内容、剪贴板）未加密